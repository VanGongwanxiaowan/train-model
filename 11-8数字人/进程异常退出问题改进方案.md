# 进程异常退出问题改进方案

## 📋 问题概述

根据任务1555失败原因分析报告，主要问题包括：
1. **工作进程异常退出**：GPU推理进程可能因为资源不足、内存溢出等原因异常退出
2. **视频写入进程异常退出**：视频编码/写入进程可能因为磁盘空间不足、权限问题等原因异常退出
3. **进程间通信中断**：进程间通信管道可能因为系统资源不足而中断

这些问题会导致 `_queue.Empty` 异常，任务执行失败。

## 🔧 改进方案

### 1. 增强进程监控系统

#### 1.1 系统资源检查
- **功能**：使用 `psutil` 库监控系统资源状态
- **检查项**：
  - 磁盘空间（使用率和剩余空间）
  - 系统内存（使用率和剩余内存）
  - Python 进程数量
  - 僵尸进程检测
- **实现位置**：`check_system_resources()` 函数

#### 1.2 进程健康检查增强
- **功能**：增强的进程健康检查，不仅检查任务状态，还检查系统进程
- **检查项**：
  - 任务状态检查
  - 系统资源检查
  - 相关进程状态检查（查找 `trans_dh_service` 和 `write_video` 相关进程）
  - 僵尸进程检测
- **实现位置**：`check_process_health()` 函数

#### 1.3 进程监控线程增强
- **功能**：增强的进程监控线程，定期检查系统资源和进程状态
- **特性**：
  - 初始系统资源检查
  - 定期资源检查（每30秒）
  - 详细的错误信息（包含系统资源状态）
  - 超时检测和自动失败设置
- **实现位置**：`monitor_process_health()` 函数

### 2. 改进队列异常检测

#### 2.1 队列长时间为空检测
- **功能**：检测队列长时间为空的情况（可能是工作进程异常退出）
- **阈值**：
  - 队列连续60次为空（约1分钟）时记录警告
  - 队列连续30次为空时记录警告日志
- **错误信息**：提供详细的错误信息，包括可能的原因和系统资源状态
- **实现位置**：`write_video_service()` 函数中的队列处理逻辑

#### 2.2 队列超时检测增强
- **功能**：增强的队列超时检测，提供详细的错误信息
- **错误信息包含**：
  - 超时时间
  - 队列为空次数
  - 可能的原因（工作进程异常退出、视频写入进程异常退出、进程间通信中断、队列阻塞、系统资源不足）
  - 系统资源状态
- **实现位置**：`write_video_service()` 函数中的超时检测

#### 2.3 错误信息增强
- **功能**：根据错误类型提供详细的错误信息
- **错误类型识别**：
  - 队列异常（QueueEmpty, Empty）
  - 超时错误
  - 其他异常
- **错误信息包含**：
  - 错误类型
  - 详细错误描述
  - 可能的原因
  - 系统资源状态（如果可用）
- **实现位置**：`write_video_service()` 函数的异常处理

### 3. 优化自动重试机制

#### 3.1 初始资源检查
- **功能**：在任务执行前检查系统资源状态
- **检查项**：
  - 磁盘空间
  - 系统内存
  - Python 进程数量
  - 僵尸进程
- **行为**：如果发现严重资源问题，记录警告但不阻止任务执行

#### 3.2 重试前资源检查
- **功能**：在每次重试前检查系统资源状态
- **行为**：
  - 如果发现严重资源问题，增加重试延迟（额外5秒）
  - 记录资源警告信息
- **目的**：避免在资源不足时立即重试，给系统时间恢复

#### 3.3 智能重试延迟
- **功能**：使用指数退避 + 随机抖动策略
- **公式**：`retry_delay = base_delay * (2 ^ (retry_count - 1)) + random(0, 1)`
- **优势**：
  - 避免重试风暴
  - 给系统时间恢复
  - 随机抖动避免多个任务同时重试

#### 3.4 详细的错误信息
- **功能**：在重试时提供详细的错误信息
- **包含内容**：
  - 错误类型
  - 错误描述
  - 队列异常时的可能原因
  - 系统资源状态
  - 重试次数

### 4. 增强错误信息传递

#### 4.1 错误信息格式化
- **功能**：根据错误类型格式化错误信息
- **格式**：
  - 队列异常：包含可能的原因和系统资源状态
  - 超时错误：包含超时时间和可能的原因
  - 其他异常：包含错误类型和描述

#### 4.2 系统资源信息附加
- **功能**：在错误信息中附加系统资源状态
- **包含内容**：
  - 磁盘空间使用率
  - 内存使用率
  - Python 进程数量
  - 僵尸进程数量
- **目的**：帮助诊断问题根本原因

## 📊 改进效果

### 1. 问题检测能力提升
- ✅ 能够检测工作进程异常退出（通过进程状态检查）
- ✅ 能够检测视频写入进程异常退出（通过进程状态检查）
- ✅ 能够检测进程间通信中断（通过队列状态检查）
- ✅ 能够检测系统资源不足（通过资源监控）

### 2. 错误信息质量提升
- ✅ 提供详细的错误信息，包括可能的原因
- ✅ 包含系统资源状态信息
- ✅ 区分不同类型的错误（队列异常、超时、资源不足等）

### 3. 自动恢复能力提升
- ✅ 智能重试机制（指数退避 + 随机抖动）
- ✅ 重试前资源检查
- ✅ 根据资源状态调整重试延迟

### 4. 问题诊断能力提升
- ✅ 详细的日志记录
- ✅ 系统资源状态记录
- ✅ 进程状态记录

## 🔍 使用说明

### 1. 安装依赖

```bash
pip install psutil
```

### 2. 配置说明

#### 2.1 进程监控配置
- `check_interval`: 进程健康检查间隔（默认5秒）
- `resource_check_interval`: 系统资源检查间隔（默认30秒）
- `max_consecutive_failures`: 连续失败阈值（默认3次）

#### 2.2 重试配置
- `max_retries`: 最大重试次数（默认3次）
- `retry_delay_base`: 基础重试延迟（默认2秒）

#### 2.3 队列监控配置
- `queue_timeout`: 队列超时时间（默认1800秒，30分钟）
- `queue_empty_warning_threshold`: 队列为空警告阈值（默认30次）
- `queue_empty_critical_threshold`: 队列为空严重警告阈值（默认60次）

### 3. 监控和诊断

#### 3.1 查看日志
- 进程健康检查日志：`[进程监控 {task_id}]`
- 系统资源检查日志：`[进程健康检查 {task_id}]`
- 队列监控日志：`Custom VideoWriter [{work_id}]`

#### 3.2 查看系统资源状态
- 磁盘空间使用率
- 内存使用率
- Python 进程数量
- 僵尸进程数量

## 📝 注意事项

### 1. psutil 依赖
- `psutil` 是可选的依赖，如果未安装，系统资源监控功能将不可用
- 建议安装 `psutil` 以获得完整的监控功能

### 2. 性能影响
- 系统资源检查会消耗一定的系统资源
- 检查间隔已优化，不会显著影响性能

### 3. 错误处理
- 如果资源检查失败，不会阻止任务执行
- 所有异常都会被正确捕获和记录

## 🎯 后续优化建议

### 1. GPU 内存监控
- 添加 GPU 内存使用率监控
- 检测 GPU 内存不足的情况

### 2. 进程间通信监控
- 监控进程间通信管道的状态
- 检测通信管道中断的情况

### 3. 自动恢复机制
- 在检测到进程异常退出时，自动重启进程
- 在检测到资源不足时，自动清理资源

### 4. 告警机制
- 在检测到严重问题时，发送告警
- 支持多种告警方式（邮件、短信、webhook等）

## 📎 相关文档

1. **问题分析文档**: `数字人服务_queue.Empty异常问题分析与解决方案.md`
2. **任务1555分析**: `任务1555失败原因详细分析报告.md`
3. **改进功能总结**: `改进功能实施总结.md`


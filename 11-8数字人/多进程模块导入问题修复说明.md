# 多进程模块导入问题修复说明

## 问题描述

### 错误现象
```
ModuleNotFoundError: No module named 'trans_dh_service'
```

### 问题原因
1. **多进程环境变量传递问题**：
   - SDK 内部使用 multiprocessing 创建子进程
   - 当使用 spawn 模式时，子进程会启动新的 Python 解释器
   - 子进程不会自动继承父进程的 `sys.path` 修改
   - 子进程只能从环境变量（如 PYTHONPATH）中获取模块路径

2. **环境变量设置时机问题**：
   - 原来的代码在导入模块之后才设置 PYTHONPATH
   - 但 SDK 可能在初始化时就开始创建子进程
   - 如果此时 PYTHONPATH 未设置，子进程无法找到模块

## 修复方案

### 1. 在模块级别设置环境变量
在 `fastapi_app.py` 文件的最开始（导入任何模块之前），设置 PYTHONPATH 环境变量：

```python
# 构建 PYTHONPATH：确保子进程能够找到模块
pythonpath_parts = [
    HEYGEM_DIR,  # 主要模块目录
    os.path.dirname(HEYGEM_DIR),  # 父目录
    os.environ.get('PYTHONPATH', '')  # 已有的 PYTHONPATH
]
# 去重并过滤空值
pythonpath_parts = [p for p in pythonpath_parts if p and p.strip()]
pythonpath = ':'.join(pythonpath_parts).strip(':')

# 设置环境变量 PYTHONPATH（子进程会继承）
os.environ['PYTHONPATH'] = pythonpath

# 同时设置 sys.path（主进程使用）
sys.path.insert(0, HEYGEM_DIR)
if os.path.dirname(HEYGEM_DIR) not in sys.path:
    sys.path.insert(0, os.path.dirname(HEYGEM_DIR))
```

### 2. 创建环境变量确保函数
创建 `_ensure_multiprocessing_env()` 函数，确保在多进程启动前环境变量已正确设置：

```python
def _ensure_multiprocessing_env():
    """
    确保多进程环境变量正确设置
    这个函数会在多进程启动前被调用
    """
    # 再次确保 PYTHONPATH 环境变量已设置
    if 'PYTHONPATH' not in os.environ or not os.environ['PYTHONPATH']:
        os.environ['PYTHONPATH'] = pythonpath
    # 确保工作目录正确
    if os.getcwd() != HEYGEM_DIR:
        os.chdir(HEYGEM_DIR)
```

### 3. 在关键位置调用环境变量确保函数
- 在 `initialize_task()` 函数开始时调用
- 在任务执行前（调用 `work()` 方法前）调用
- 在 `write_video_service()` 函数开始时调用（如果该函数在子进程中运行）

## 修复的关键点

1. **模块级别设置**：在文件开头设置 PYTHONPATH，确保在导入任何模块之前环境变量已设置
2. **环境变量继承**：确保子进程能够从环境变量中获取 PYTHONPATH
3. **多次确保**：在关键位置多次检查和设置环境变量，确保不会丢失
4. **工作目录**：确保工作目录正确，因为模块路径可能依赖于工作目录

## 验证方法

### 1. 检查环境变量
```bash
docker exec starpainting-digital-human-service-1 python -c "import os; print('PYTHONPATH:', os.environ.get('PYTHONPATH'))"
```

### 2. 检查模块导入
```bash
docker exec starpainting-digital-human-service-1 python -c "import sys; sys.path.insert(0, '/app/HeyGem-Linux-Python-Hack'); import service.trans_dh_service; print('Import successful')"
```

### 3. 检查服务日志
查看服务日志，确认没有 `ModuleNotFoundError` 错误：
```bash
docker logs starpainting-digital-human-service-1 | grep -i "ModuleNotFoundError"
```

## 预期效果

修复后，应该能够：
1. ✅ 服务正常启动，没有模块导入错误
2. ✅ SDK 初始化成功，模型加载完成
3. ✅ 任务执行时，子进程能够正确导入模块
4. ✅ 不再出现 `ModuleNotFoundError: No module named 'trans_dh_service'` 错误

## 注意事项

1. **Python 版本兼容性**：确保使用的 Python 版本与编译的 .so 文件版本匹配
2. **环境变量 persistence**：确保环境变量在容器重启后仍然存在（如果需要在容器级别设置）
3. **多进程启动方法**：如果 SDK 内部使用了特定的启动方法（spawn/fork），需要确保环境变量能够正确传递

## 相关文件

- `fastapi_app.py`: 主要修复文件
- `HeyGem-Linux-Python-Hack/service/trans_dh_service.cpython-38-x86_64-linux-gnu.so`: 模块文件

## 修复日期

2025-11-09

## 修复人员

AI Assistant


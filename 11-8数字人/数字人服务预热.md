# 数字人服务预热机制说明

## 概述

服务预热机制在服务启动后自动执行一个测试任务，确保 SDK 的多进程和队列完全就绪，从而减少 `_queue.Empty` 异常的发生。

## 工作原理

### 1. 启动流程

1. **服务启动**：服务正常启动，加载模型
2. **模型初始化**：等待 30 秒，确保模型完全加载
3. **启动预热线程**：在后台线程中启动预热任务（不阻塞服务启动）
4. **服务就绪**：服务立即可用，可以接受真实请求

### 2. 预热流程

1. **等待模型加载**：预热线程等待 10 秒，确保模型完全加载
2. **检查测试文件**：验证测试音频和视频文件是否存在
3. **初始化任务**：创建预热任务ID，初始化任务字典
4. **等待队列初始化**：等待 40 秒，确保多进程队列完全初始化
5. **执行预热任务**：调用 `task_instance.work()` 方法执行测试任务
6. **等待任务完成**：最多等待 60 秒，等待任务完成
7. **清理资源**：清理任务状态和临时文件

### 3. 预热结果

- **成功**：预热任务执行成功，SDK 完全就绪 ✅
- **失败**：预热任务执行失败，记录警告但不阻止服务启动 ⚠️
- **超时**：预热任务超时，记录警告但不阻止服务启动 ⚠️

## 配置

### 测试文件

- **音频文件**: `/data2/home_back/gujiaxin/work/starpainting/backend/services/digital-human-service/孙膑感念知遇01.mp3`
- **视频文件**: `/data2/home_back/gujiaxin/work/batchshort1/assrt/human/岁月茶话间.mp4`

### 时间参数

- **模型初始化等待**: 30 秒（在 `initialize_task()` 中）
- **预热线程等待**: 10 秒（确保模型完全加载）
- **队列初始化等待**: 40 秒（比正常任务多 10 秒）
- **任务完成等待**: 最多 60 秒

### 输出目录

- **预热输出目录**: `/data2/home_back/gujiaxin/work/batchshort1/assrt/human/.warmup/`
- **临时文件**: 预热完成后会自动清理

## 日志示例

### 成功的预热

```
================================================================================
🔥 开始服务预热...
================================================================================
预热：等待10秒，确保模型完全加载...
预热：使用测试文件进行预热
   音频文件: /data2/.../孙膑感念知遇01.mp3 (197632 bytes)
   视频文件: /data2/.../岁月茶话间.mp4 (14316424 bytes)
   任务ID: warmup-abc12345
   预热输出目录: /data2/.../.warmup
预热：等待40秒，确保多进程队列完全初始化...
预热：开始执行预热任务...
预热：work() 方法调用完成，耗时: 15.23 秒
预热：等待任务完成（最多60秒）...
✅ 预热：任务执行成功（耗时: 25.45 秒）
   结果路径: /data2/.../warmup-abc12345-r.mp4
预热：已清理预热输出文件: /data2/.../warmup-abc12345-r.mp4
================================================================================
🔥 服务预热完成
================================================================================
```

### 失败的预热

```
================================================================================
🔥 开始服务预热...
================================================================================
预热：等待10秒，确保模型完全加载...
预热：使用测试文件进行预热
预热：等待40秒，确保多进程队列完全初始化...
预热：开始执行预热任务...
预热：work() 方法调用完成，耗时: 12.34 秒
预热：等待任务完成（最多60秒）...
⚠️ 预热：任务执行失败（耗时: 22.56 秒）
   错误信息: 数字人生成服务内部错误：多进程队列异常（_queue.Empty）...
   注意：预热失败不影响服务启动，但可能表示 SDK 未完全就绪
================================================================================
🔥 服务预热完成
================================================================================
```

## 优势

### 1. 非阻塞启动
- 预热任务在后台线程中运行，不阻塞服务启动
- 服务立即可用，可以接受真实请求

### 2. 自动清理
- 预热任务完成后自动清理任务状态
- 自动清理临时输出文件

### 3. 容错处理
- 预热失败不影响服务启动
- 记录详细的日志，便于问题排查

### 4. 资源优化
- 预热任务使用较小的测试文件
- 预热完成后自动清理临时文件

## 注意事项

### 1. 测试文件
- 确保测试音频和视频文件存在
- 如果测试文件不存在，预热会跳过，但不影响服务启动

### 2. 预热时间
- 预热任务可能需要 1-2 分钟完成
- 在预热完成之前，服务可能仍然会出现 `_queue.Empty` 异常

### 3. 资源使用
- 预热任务会占用 GPU 和 CPU 资源
- 预热任务在后台运行，不会影响正常请求的处理

### 4. 日志监控
- 关注预热任务的日志，了解 SDK 是否完全就绪
- 如果预热失败，可能需要增加等待时间或检查系统资源

## 故障排查

### 预热失败
1. **检查测试文件**：确保测试音频和视频文件存在
2. **检查系统资源**：确保 GPU 和系统内存充足
3. **检查日志**：查看详细的错误信息
4. **增加等待时间**：如果问题持续，可以增加等待时间

### 预热超时
1. **检查系统负载**：确保系统资源充足
2. **增加超时时间**：可以增加 `max_wait_time` 参数
3. **检查 SDK 状态**：确保 SDK 正常工作

## 修改建议

### 如果需要修改预热参数

1. **修改等待时间**：
   ```python
   # 在 warmup_service() 函数中
   time.sleep(40)  # 修改这个值
   ```

2. **修改超时时间**：
   ```python
   # 在 warmup_service() 函数中
   max_wait_time = 60  # 修改这个值（秒）
   ```

3. **修改测试文件**：
   ```python
   # 在 warmup_service() 函数中
   test_audio_path = "你的音频文件路径"
   test_video_path = "你的视频文件路径"
   ```

## 总结

服务预热机制通过执行一个测试任务，确保 SDK 的多进程和队列完全就绪，从而减少 `_queue.Empty` 异常的发生。预热任务在后台运行，不阻塞服务启动，即使预热失败也不会影响服务的正常使用。

## 相关文件

- 实现代码: `fastapi_app.py` (第813-960行)
- 测试文件: 
  - 音频: `孙膑感念知遇01.mp3`
  - 视频: `/data2/home_back/gujiaxin/work/batchshort1/assrt/human/岁月茶话间.mp4`


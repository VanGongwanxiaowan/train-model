# 数字人生成服务客户端调用指南
> ⚠️ **强制要求**：所有业务代码必须使用 `pipe_line.py` 提供的 `call_digital_human_service` 封装函数。如无特殊审批，禁止直接调用 `requests.post` 访问 `/human/generate`。

## 正确的调用方式

### ✅ 推荐方式：使用封装函数

在 `pipe_line.py` 中已经提供了封装函数 `call_digital_human_service`，这是**推荐的使用方式**：

```python
from pipe_line import call_digital_human_service

# 调用数字人生成服务
try:
    success = call_digital_human_service(
        audio_path="/data2/xxx.mp3",
        video_path="/data2/xxxx/template.mp4",
        save_path="/data2/xxxx/output.mp4",
        timeout=1800  # 30分钟超时
    )
    if success:
        print("数字人生成成功")
    else:
        print("数字人生成失败")
except Exception as e:
    print(f"调用失败: {e}")
```

### ✅ 直接调用方式（如果必须使用 requests）

如果必须直接使用 `requests.post`，**必须**检查响应和错误处理：

```python
import requests
import json
import os

DIGITAL_HUMAN_SERVICE_URL = "http://192.168.191.56:8308/human/generate"
TIMEOUT = 1800  # 30分钟超时

def call_digital_human_service_direct(audio_path: str, video_path: str, save_path: str):
    """
    直接调用数字人生成服务（带完整的错误处理）
    """
    try:
        request_data = {
            "audio_path": audio_path,
            "video_path": video_path,
            "save_path": save_path,
        }
        
        # 1. 发送请求（必须设置超时）
        response = requests.post(
            DIGITAL_HUMAN_SERVICE_URL,
            json=request_data,
            timeout=TIMEOUT  # ⚠️ 必须设置超时
        )
        
        # 2. 检查 HTTP 状态码
        if response.status_code != 200:
            raise Exception(f"HTTP 错误: {response.status_code}, 响应: {response.text}")
        
        # 3. 解析 JSON 响应
        try:
            result = response.json()
        except json.JSONDecodeError:
            raise Exception(f"响应不是有效的 JSON: {response.text}")
        
        # 4. 检查业务状态码
        if result.get("code") != 200:
            error_msg = result.get("message", "未知错误")
            raise Exception(f"业务错误: code={result.get('code')}, message={error_msg}")
        
        # 5. 验证输出文件是否存在
        if not os.path.exists(save_path):
            raise Exception(f"输出文件不存在: {save_path}")
        
        # 6. 验证文件大小
        file_size = os.path.getsize(save_path)
        if file_size == 0:
            raise Exception(f"输出文件大小为0: {save_path}")
        
        print(f"✅ 数字人生成成功: {save_path}, 大小: {file_size} bytes")
        return True
        
    except requests.exceptions.Timeout:
        raise Exception(f"请求超时: {TIMEOUT}秒")
    except requests.exceptions.ConnectionError as e:
        raise Exception(f"连接失败: {str(e)}")
    except Exception as e:
        raise Exception(f"调用失败: {str(e)}")
```

## ❌ 错误的调用方式

### 错误示例 1：没有检查响应

```python
# ❌ 错误：没有检查响应，没有等待完成
requests.post("http://192.168.191.56:8308/human/generate", json=request_data)
# 继续执行后续代码，但不知道服务是否成功
```

**问题**：
- 不知道服务是否成功
- 不知道是否出错
- 可能继续执行导致后续步骤失败

### 错误示例 2：没有设置超时

```python
# ❌ 错误：没有设置超时，可能无限等待
response = requests.post("http://192.168.191.56:8308/human/generate", json=request_data)
```

**问题**：
- 如果服务端处理时间很长，可能无限等待
- 无法及时检测到服务端问题

### 错误示例 3：没有错误处理

```python
# ❌ 错误：没有错误处理
response = requests.post("http://192.168.191.56:8308/human/generate", json=request_data)
result = response.json()
# 如果响应不是 JSON 或服务出错，这里会崩溃
```

**问题**：
- 如果服务端返回错误，程序会崩溃
- 无法处理网络错误

## 完整示例：处理 Intro 视频

### ✅ 正确的方式

```python
import os
import subprocess
from pipe_line import call_digital_human_service

# --- Generate Intro Human Video ---
if intro_duration > 0:
    # 1. 截取音频
    command_audio_intro = f"ffmpeg -y -i '{audio_path}' -ss 00:00:00 -t {intro_duration} -y -acodec copy '{short_audio_intro_path}'"
    result = subprocess.run(command_audio_intro, shell=True, capture_output=True, text=True)
    if result.returncode != 0:
        raise Exception(f"音频截取失败: {result.stderr}")
    
    # 2. 调用数字人生成服务（使用封装函数）
    try:
        call_digital_human_service(
            audio_path=short_audio_intro_path,
            video_path=human_video_source_path,
            save_path=human_generate_intro_path,
            timeout=1800
        )
    except Exception as e:
        raise Exception(f"数字人生成失败: {e}")
    
    # 3. 验证文件是否存在
    if not os.path.exists(human_generate_intro_path):
        raise Exception(f"生成的视频文件不存在: {human_generate_intro_path}")
    
    # 4. 处理生成的视频（调整分辨率）
    human_commad_intro = f'ffmpeg -y -i "{human_generate_intro_path}" -an -r 30 -pix_fmt yuv420p -vf "scale=1360:768:flags=lanczos,setsar=1" "{human_video_intro_final_path}"'
    result = subprocess.run(human_commad_intro, shell=True, capture_output=True, text=True)
    if result.returncode != 0:
        raise Exception(f"视频处理失败: {result.stderr}")
```

### ❌ 错误的方式（用户提到的代码片段）

```python
# ❌ 错误：没有检查响应，没有等待完成
if intro_duration > 0:
    command_audio_intro = f"ffmpeg -y -i '{audio_path}' -ss 00:00:00 -t {intro_duration} -y -acod..."
    os.system(command_audio_intro)
    request_data_intro = {
        "audio_path": short_audio_intro_path,
        "video_path": human_video_source_path,
        "save_path": human_generate_intro_path,
    }
    # ❌ 问题1: 没有检查响应
    # ❌ 问题2: 没有等待完成
    # ❌ 问题3: 没有错误处理
    # ❌ 问题4: 没有超时设置
    requests.post("http://192.168.191.56:8308/human/generate", json=request_data_intro)
    
    # ❌ 问题5: 可能文件还没生成就继续执行
    human_commad_intro = f' ffmpeg -y -i "{human_generate_intro_path}" -an -r 30 -pix_fmt yuv420p setsar=1 "{human_video_intro_final_path}"'
    os.system(human_commad_intro)
```

## API 响应格式

### 成功响应

```json
{
    "code": 200,
    "message": "success",
    "data": {
        "save_path": "/data2/xxxx/output.mp4",
        "task_id": "uuid"
    }
}
```

### 错误响应

```json
{
    "code": 500,
    "message": "Failed to generate digital human video: 错误信息",
    "data": {}
}
```

## 注意事项

1. **必须设置超时**：数字人生成可能需要较长时间，建议设置 1800 秒（30分钟）超时
2. **必须检查响应**：检查 HTTP 状态码和业务状态码
3. **必须验证文件**：生成完成后验证输出文件是否存在且大小不为0
4. **必须处理错误**：捕获并处理所有可能的异常
5. **推荐使用封装函数**：使用 `call_digital_human_service` 函数，它已经包含了所有必要的检查

## 常见错误

### 1. 超时错误

```
❌ 数字人生成服务请求超时: timeout=1800s
```

**原因**：服务端处理时间超过超时时间
**解决**：增加超时时间，或检查服务端是否正常

### 2. 连接失败

```
❌ 数字人生成服务连接失败: Connection refused
```

**原因**：服务端未启动或端口不可访问
**解决**：检查服务端是否运行，检查网络连接

### 3. 文件不存在

```
❌ 数字人生成完成，但输出文件不存在
```

**原因**：服务端生成失败或路径错误
**解决**：检查服务端日志，验证路径是否正确

### 4. 业务错误

```
❌ 数字人生成服务业务错误: code=500, message=错误信息
```

**原因**：服务端处理失败
**解决**：查看服务端日志获取详细错误信息


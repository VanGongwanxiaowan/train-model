# 数字人服务模型和依赖文件检查报告

## 检查时间
2025-11-07

## 检查结果总结

### ✅ 已存在的模型文件
1. **GFPGANv1.4.onnx** - 人脸修复模型 ✓
2. **79999_iter.onnx** - 人脸解析模型 ✓
3. **wenetmodel.pt** - WeNet语音识别模型 ✓
4. **pfpld_robust_sim_bs1_8003.onnx** - 人脸关键点检测模型 ✓
5. **scrfd_500m_bnkps_shape640x640.onnx** - 人脸检测模型 ✓
6. **model_float32.onnx** - 人脸检测模型 ✓

### ❌ 缺失的关键模型文件
1. **dinet_v1_20240131.pth** - 数字人生成核心模型（最重要）❌
   - 位置: `landmark2face_wy/checkpoints/anylang/dinet_v1_20240131.pth`
   - 说明: 这是数字人生成的核心模型，缺失会导致任务执行失败

2. **xseg_211104_4790000.onnx** - XSeg分割模型 ❌
   - 位置: `xseg/xseg_211104_4790000.onnx`
   - 说明: 用于人脸分割处理

3. **face_attr_epoch_12_220318.onnx** - 人脸属性检测模型 ❌
   - 位置: `face_attr_detect/face_attr_epoch_12_220318.onnx`
   - 说明: 用于人脸属性检测

## 文件统计
- .so 文件: 80 个
- 模型文件: 6 个（缺少 3 个关键模型）

## 问题分析

### 根本原因
根据日志分析，任务执行失败但错误信息为空，很可能是因为：
1. **缺少核心模型文件 `dinet_v1_20240131.pth`**，导致模型加载失败
2. 模型加载失败时，`trans_dh_service` 内部捕获了异常但未正确设置错误信息
3. 任务在 `get_aud_feat1` 后约 10 秒失败，说明模型初始化或加载过程中出现问题

### 影响
- 数字人生成任务无法正常执行
- 任务失败但错误信息为空，难以定位问题
- 服务虽然能启动，但无法处理实际任务

## 修复方案

### 方案1: 使用检查脚本自动下载（推荐）
```bash
cd /data2/home_back/gujiaxin/work/starpainting/backend/services/digital-human-service
bash check_and_fix_models.sh
# 输入 y 确认下载
```

### 方案2: 手动下载缺失的模型文件
```bash
cd /data2/home_back/gujiaxin/work/starpainting/backend/services/digital-human-service/HeyGem-Linux-Python-Hack

# 下载数字人生成核心模型
mkdir -p landmark2face_wy/checkpoints/anylang
wget https://github.com/Holasyb918/HeyGem-Linux-Python-Hack/releases/download/ckpts_and_onnx/dinet_v1_20240131.pth \
  -O landmark2face_wy/checkpoints/anylang/dinet_v1_20240131.pth

# 下载XSeg模型
mkdir -p xseg
wget https://github.com/Holasyb918/HeyGem-Linux-Python-Hack/releases/download/ckpts_and_onnx/xseg_211104_4790000.onnx \
  -O xseg/xseg_211104_4790000.onnx

# 下载人脸属性检测模型
mkdir -p face_attr_detect
wget https://github.com/Holasyb918/HeyGem-Linux-Python-Hack/releases/download/ckpts_and_onnx/face_attr_epoch_12_220318.onnx \
  -O face_attr_detect/face_attr_epoch_12_220318.onnx
```

### 方案3: 使用原始下载脚本
```bash
cd /data2/home_back/gujiaxin/work/starpainting/backend/services/digital-human-service/HeyGem-Linux-Python-Hack
bash download.sh
```

## 验证步骤

修复后，请执行以下步骤验证：

1. **检查模型文件是否完整**
   ```bash
   bash check_and_fix_models.sh
   ```

2. **重启服务**
   ```bash
   # 如果使用容器
   docker-compose restart digital-human-service
   
   # 或者直接重启服务
   systemctl restart digital-human-service
   ```

3. **检查服务日志**
   ```bash
   tail -f HeyGem-Linux-Python-Hack/log/dh.log
   ```
   确认模型加载成功，没有错误信息

4. **测试API**
   ```bash
   curl -X POST http://localhost:8308/human/generate \
     -H "Content-Type: application/json" \
     -d '{
       "audio_path": "example/audio.wav",
       "video_path": "example/video.mp4",
       "save_path": "result/test.mp4"
     }'
   ```

## 依赖文件检查

### Python 依赖
- 需要检查 `requirements.txt` 中的所有包是否已安装
- 关键依赖：torch, onnxruntime-gpu, opencv-python, numpy 等

### 系统依赖
- ffmpeg: 需要安装
- CUDA: 需要正确配置（如果使用GPU）

## 配置文件检查

### config.ini
- 位置: `HeyGem-Linux-Python-Hack/config/config.ini`
- 需要检查配置是否正确

## 建议

1. **立即修复**: 下载缺失的 3 个关键模型文件，特别是 `dinet_v1_20240131.pth`
2. **定期检查**: 使用 `check_and_fix_models.sh` 脚本定期检查模型文件完整性
3. **容器化**: 如果使用容器，建议在构建镜像时包含所有模型文件
4. **监控**: 添加模型文件完整性检查到服务启动流程中

## 相关文件

- 检查脚本: `check_and_fix_models.sh`
- 下载脚本: `HeyGem-Linux-Python-Hack/download.sh`
- 配置文件: `HeyGem-Linux-Python-Hack/config/config.ini`
- 服务代码: `fastapi_app.py`












# 环境版本问题报告

## ⚠️ 严重问题：关键包版本不匹配

### 不匹配的包

| 包名 | 当前版本 | 目标版本 | 状态 |
|------|---------|---------|------|
| **torch** | 2.4.1 | 1.11.0+cu113 | ❌ 严重不匹配 |
| **torchaudio** | 2.4.1 | 0.11.0+cu113 | ❌ 严重不匹配 |
| **torchvision** | 0.19.1 | 0.12.0+cu113 | ❌ 严重不匹配 |
| **onnxruntime-gpu** | 1.19.2 | 1.16.0 | ❌ 不匹配 |

### 匹配的包

以下包版本正确：
- ✓ gradio: 4.44.1
- ✓ fastapi: 0.115.11
- ✓ uvicorn: 0.33.0
- ✓ numpy: 1.24.4
- ✓ opencv-python: 4.11.0.86
- ✓ librosa: 0.11.0
- ✓ scipy: 1.10.1
- ✓ pandas: 2.0.3
- ✓ pillow: 10.4.0
- ✓ pydantic: 2.10.6
- ✓ starlette: 0.44.0
- ✓ 其他依赖包: 版本正确

## 问题影响

### 1. PyTorch 版本问题
- **当前**: PyTorch 2.4.1（最新版）
- **需要**: PyTorch 1.11.0+cu113（CUDA 11.3）
- **影响**:
  - 模型兼容性问题
  - GPU 驱动可能不兼容
  - API 变更导致代码错误
  - 性能问题

### 2. ONNX Runtime GPU 版本问题
- **当前**: onnxruntime-gpu 1.19.2
- **需要**: onnxruntime-gpu 1.16.0
- **影响**:
  - CUDA/cuDNN 版本要求不匹配
  - GPU 无法正确使用
  - 模型推理失败

### 3. 队列阻塞问题
- 版本不匹配导致模型加载失败
- GPU 无法正确初始化
- 视频帧生成进程异常
- 队列阻塞

## 修复方案

### 步骤1: 卸载不匹配的包

```bash
docker exec starpainting-digital-human-service-1 bash -c "source /opt/conda/etc/profile.d/conda.sh && conda activate human && pip uninstall -y torch torchvision torchaudio onnxruntime-gpu onnxruntime"
```

### 步骤2: 安装正确版本的 PyTorch

```bash
docker exec starpainting-digital-human-service-1 bash -c "source /opt/conda/etc/profile.d/conda.sh && conda activate human && pip install torch==1.11.0+cu113 torchvision==0.12.0+cu113 torchaudio==0.11.0+cu113 --extra-index-url https://download.pytorch.org/whl/cu113"
```

### 步骤3: 安装正确版本的 ONNX Runtime GPU

```bash
docker exec starpainting-digital-human-service-1 bash -c "source /opt/conda/etc/profile.d/conda.sh && conda activate human && pip install onnxruntime-gpu==1.16.0"
```

### 步骤4: 验证安装

```bash
docker exec starpainting-digital-human-service-1 bash -c "source /opt/conda/etc/profile.d/conda.sh && conda activate human && python -c 'import torch; print(f\"PyTorch: {torch.__version__}\"); print(f\"CUDA available: {torch.cuda.is_available()}\")'"
```

### 步骤5: 重启服务

```bash
# 重启 Gradio 应用
docker exec starpainting-digital-human-service-1 bash -c "pkill -f 'python app.py'"
docker exec starpainting-digital-human-service-1 bash -c "source /opt/conda/etc/profile.d/conda.sh && conda activate human && cd /app/HeyGem-Linux-Python-Hack && export PYTHONPATH=/app/HeyGem-Linux-Python-Hack && export LD_LIBRARY_PATH=/opt/conda/envs/human/lib:\$LD_LIBRARY_PATH && nohup python app.py > /tmp/gradio.log 2>&1 &"
```

## 注意事项

1. **PyTorch 1.11.0+cu113 需要 CUDA 11.3**
   - 确保系统有 CUDA 11.3 支持
   - 或者使用 conda 安装 cudatoolkit

2. **ONNX Runtime GPU 1.16.0 需要 CUDA 11.x**
   - 我们已经安装了 cudatoolkit 11.8.0
   - 需要确保 LD_LIBRARY_PATH 正确设置

3. **依赖冲突**
   - 降级 PyTorch 可能会影响其他依赖
   - 需要重新安装相关包

4. **GPU 驱动**
   - 确保 GPU 驱动支持 CUDA 11.3
   - 检查 nvidia-smi 输出

## 完整修复脚本

已创建 `fix_environment.sh` 脚本，包含完整的修复步骤。

## 日期

2025-11-09


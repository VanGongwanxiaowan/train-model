# 队列阻塞问题修复总结

## 已完成的修复

### 1. ✅ PyTorch 版本回退
- **从**: PyTorch 2.4.1+cu118（不稳定）
- **到**: PyTorch 2.1.2+cu118（稳定版本）
- **文件**: `requirements_0.txt`
- **更改内容**:
  - `torch==2.1.2+cu118`
  - `torchaudio==2.1.2+cu118`
  - `torchvision==0.16.2+cu118`
  - `triton==2.1.0`

### 2. ✅ 关键依赖版本调整
匹配稳定配置的依赖版本：

| 包名 | 旧版本 | 新版本 | 状态 |
|------|--------|--------|------|
| numpy | 1.24.4 | 1.22.4 | ✅ |
| opencv-python | 4.11.0.86 | 4.7.0.72 | ✅ |
| librosa | 0.11.0 | 0.8.1 | ✅ |
| numba | 0.58.1 | 0.55.2 | ✅ |
| scikit-image | 0.21.0 | 0.19.3 | ✅ |
| scikit-learn | 1.3.2 | 1.0.2 | ✅ |
| pillow | 10.4.0 | 9.1.1 | ✅ |
| typeguard | - | 2.13.3 | ✅ |

### 3. ✅ 多进程/多线程优化
在 `app.py` 中添加了以下优化：

#### 环境变量配置（第 6-16 行）
```python
os.environ["OPENCV_OPENCL_RUNTIME"] = ""
os.environ["OMP_NUM_THREADS"] = "1"
os.environ["MKL_NUM_THREADS"] = "1"
os.environ["NUMEXPR_NUM_THREADS"] = "1"
os.environ["TORCH_NUM_THREADS"] = "1"
os.environ["PYTORCH_CUDA_ALLOC_CONF"] = "max_split_size_mb:128"
```

#### OpenCV 单线程配置（第 28-35 行）
```python
cv2.setNumThreads(0)
cv2.ocl.setUseOpenCL(False)
```

### 4. ✅ 创建辅助文件
- `队列阻塞问题修复说明.md` - 详细的问题分析和修复方案
- `update_pytorch.sh` - 自动化更新脚本
- `修复总结.md` - 本文档

## 下一步操作

### 1. 更新 Docker 容器中的依赖

**方法一：使用自动化脚本（推荐）**

```bash
# 将脚本复制到容器中
docker cp update_pytorch.sh starpainting-digital-human-service-1:/app/HeyGem-Linux-Python-Hack/

# 在容器内执行
docker exec -it starpainting-digital-human-service-1 bash -c "cd /app/HeyGem-Linux-Python-Hack && bash update_pytorch.sh"
```

**方法二：手动执行**

```bash
# 进入容器
docker exec -it starpainting-digital-human-service-1 bash

# 激活 conda 环境
source /opt/conda/etc/profile.d/conda.sh
conda activate human

# 进入项目目录
cd /app/HeyGem-Linux-Python-Hack

# 卸载旧版本
pip uninstall -y torch torchvision torchaudio triton

# 安装新版本
pip install torch==2.1.2+cu118 torchvision==0.16.2+cu118 torchaudio==2.1.2+cu118 triton==2.1.0 \
    --index-url https://download.pytorch.org/whl/cu118 \
    -i https://pypi.tuna.tsinghua.edu.cn/simple

# 更新其他依赖
pip install -r requirements_0.txt -i https://pypi.tuna.tsinghua.edu.cn/simple
```

### 2. 验证安装

```bash
docker exec starpainting-digital-human-service-1 bash -c "source /opt/conda/etc/profile.d/conda.sh && conda activate human && python -c 'import torch; print(f\"PyTorch: {torch.__version__}\"); print(f\"CUDA: {torch.cuda.is_available()}\")'"
```

### 3. 重启服务

```bash
# 停止旧服务
docker exec starpainting-digital-human-service-1 pkill -f "python app.py"

# 等待进程完全停止
sleep 2

# 启动新服务
docker exec starpainting-digital-human-service-1 bash -c "source /opt/conda/etc/profile.d/conda.sh && conda activate human && cd /app/HeyGem-Linux-Python-Hack && nohup python app.py > /tmp/gradio.log 2>&1 &"

# 检查服务状态
docker exec starpainting-digital-human-service-1 ps aux | grep "python app.py" | grep -v grep
```

### 4. 检查 Docker 共享内存配置

如果问题仍然存在，需要增加 Docker 容器的共享内存：

```bash
# 检查当前容器配置
docker inspect starpainting-digital-human-service-1 | grep -i shm

# 如果共享内存不足，需要重新创建容器并添加 --shm-size 参数
docker stop starpainting-digital-human-service-1
docker rm starpainting-digital-human-service-1

# 重新创建容器时添加共享内存配置
docker run -d \
  --name starpainting-digital-human-service-1 \
  --gpus all \
  --shm-size=2g \
  -p 8308:8308 \
  -p 7860:7860 \
  -v /data2/home_back/gujiaxin/work/starpainting/backend/services/digital-human-service:/app \
  heygem:v2.2
```

## 验证修复效果

### 1. 检查日志

```bash
# 查看服务日志
docker exec starpainting-digital-human-service-1 tail -f /tmp/gradio.log

# 查看应用日志
docker exec starpainting-digital-human-service-1 tail -f /app/HeyGem-Linux-Python-Hack/log/dh.log
```

### 2. 测试视频生成

通过 Gradio Web 界面（http://localhost:7860）上传音频和视频文件，验证是否能正常生成，不再出现"队列满"错误。

### 3. 监控资源使用

```bash
# 监控 GPU 使用
nvidia-smi -l 1

# 监控 CPU 和内存
docker exec starpainting-digital-human-service-1 top
```

## 已知问题

1. **wenetmodel.pt 文件**：确保 wenet 模型文件已正确放置在指定路径
2. **CUDA 驱动**：确保 NVIDIA 驱动版本与 CUDA 11.8 兼容
3. **共享内存**：如果问题仍然存在，可以尝试增加共享内存大小到 4GB

## 回滚方案

如果新版本出现问题，可以回滚到之前的配置：

```bash
# 恢复 requirements_0.txt 到之前的版本
git checkout HEAD -- requirements_0.txt

# 或者手动修改 app.py，移除多线程优化配置
```

## 相关文件

- `requirements_0.txt` - 依赖配置文件
- `app.py` - 主应用文件（已添加多线程优化）
- `队列阻塞问题修复说明.md` - 详细的问题分析
- `update_pytorch.sh` - 自动化更新脚本

## 更新日期

2025-11-09


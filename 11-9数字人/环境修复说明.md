# 环境版本修复说明

## 🔍 问题诊断

### 发现的版本不匹配问题

1. **PyTorch 版本严重不匹配**
   - 当前: `torch==2.4.1`
   - 需要: `torch==1.11.0+cu113`
   - **影响**: 这是导致队列阻塞和GPU无法使用的根本原因

2. **TorchVision 版本不匹配**
   - 当前: `torchvision==0.19.1`
   - 需要: `torchvision==0.12.0+cu113`

3. **TorchAudio 版本不匹配**
   - 当前: `torchaudio==2.4.1`
   - 需要: `torchaudio==0.11.0+cu113`

4. **ONNX Runtime GPU 版本不匹配**
   - 当前: `onnxruntime-gpu==1.19.2`
   - 需要: `onnxruntime-gpu==1.16.0`
   - **影响**: 我们已经修复过这个问题，但版本仍然不对

## 🛠️ 修复步骤

### 方法1: 使用自动修复脚本（推荐）

```bash
cd /data2/home_back/gujiaxin/work/starpainting/backend/services/digital-human-service
./fix_environment.sh
```

### 方法2: 手动修复

#### 步骤1: 停止当前服务

```bash
# 停止 Gradio 应用
docker exec starpainting-digital-human-service-1 pkill -f "python app.py"

# 停止 FastAPI 服务（如果需要）
docker exec starpainting-digital-human-service-1 pkill -f "uvicorn fastapi_app"
```

#### 步骤2: 卸载不匹配的包

```bash
docker exec starpainting-digital-human-service-1 bash -c "source /opt/conda/etc/profile.d/conda.sh && conda activate human && pip uninstall -y torch torchvision torchaudio onnxruntime-gpu onnxruntime"
```

#### 步骤3: 安装正确版本的 PyTorch

**注意**: PyTorch 1.11.0+cu113 需要从 PyTorch 官方源安装，因为 pip 可能没有这个版本。

```bash
# 方法A: 使用 PyTorch 官方索引（推荐）
docker exec starpainting-digital-human-service-1 bash -c "source /opt/conda/etc/profile.d/conda.sh && conda activate human && pip install torch==1.11.0+cu113 torchvision==0.12.0+cu113 torchaudio==0.11.0+cu113 --extra-index-url https://download.pytorch.org/whl/cu113"

# 方法B: 如果方法A失败，尝试使用 conda 安装
docker exec starpainting-digital-human-service-1 bash -c "source /opt/conda/etc/profile.d/conda.sh && conda activate human && conda install -y pytorch==1.11.0 torchvision==0.12.0 torchaudio==0.11.0 cudatoolkit=11.3 -c pytorch"
```

#### 步骤4: 安装正确版本的 ONNX Runtime GPU

```bash
docker exec starpainting-digital-human-service-1 bash -c "source /opt/conda/etc/profile.d/conda.sh && conda activate human && pip install onnxruntime-gpu==1.16.0"
```

#### 步骤5: 验证安装

```bash
# 验证 PyTorch
docker exec starpainting-digital-human-service-1 bash -c "source /opt/conda/etc/profile.d/conda.sh && conda activate human && python -c 'import torch; print(f\"PyTorch: {torch.__version__}\"); print(f\"CUDA available: {torch.cuda.is_available()}\"); print(f\"CUDA version: {torch.version.cuda if torch.cuda.is_available() else \"N/A\"}\")'"

# 验证 ONNX Runtime
docker exec starpainting-digital-human-service-1 bash -c "source /opt/conda/etc/profile.d/conda.sh && conda activate human && python -c 'import onnxruntime as ort; print(f\"ONNX Runtime: {ort.__version__}\"); providers = ort.get_available_providers(); print(f\"Providers: {providers}\")'"
```

#### 步骤6: 重启服务

```bash
# 重启 FastAPI 服务
docker exec starpainting-digital-human-service-1 bash -c "cd /app && source /opt/conda/etc/profile.d/conda.sh && conda activate human && nohup uvicorn fastapi_app:app --host 0.0.0.0 --port 8308 > /tmp/fastapi.log 2>&1 &"

# 重启 Gradio 应用
docker exec starpainting-digital-human-service-1 bash -c "source /opt/conda/etc/profile.d/conda.sh && conda activate human && cd /app/HeyGem-Linux-Python-Hack && export PYTHONPATH=/app/HeyGem-Linux-Python-Hack && export LD_LIBRARY_PATH=/opt/conda/envs/human/lib:\$LD_LIBRARY_PATH && nohup python app.py > /tmp/gradio.log 2>&1 &"
```

## ⚠️ 重要注意事项

### 1. PyTorch 1.11.0+cu113 安装问题

PyTorch 1.11.0 是一个较旧的版本（2022年发布），可能面临以下问题：

- **pip 源可能没有此版本**: 需要使用 `--extra-index-url` 或从 conda 安装
- **CUDA 11.3 支持**: 确保系统支持 CUDA 11.3，或者使用 conda 的 cudatoolkit
- **依赖冲突**: 降级 PyTorch 可能会影响其他依赖包

### 2. 替代方案

如果无法安装 PyTorch 1.11.0+cu113，可以考虑：

1. **使用 conda 安装**: conda 通常有更好的旧版本支持
2. **使用 Docker 镜像**: 使用包含正确版本 PyTorch 的 Docker 镜像
3. **检查 SDK 兼容性**: 确认 SDK 是否真的需要 PyTorch 1.11.0，还是可以兼容更新版本

### 3. CUDA 版本兼容性

- PyTorch 1.11.0+cu113 需要 CUDA 11.3
- 当前系统可能有 CUDA 12.x（从 nvidia-cudnn-cu12 可以看出）
- 可能需要使用 conda 的 cudatoolkit 来提供 CUDA 11.3 支持

### 4. 验证 GPU 可用性

修复后，运行以下命令验证 GPU 是否可用：

```bash
docker exec starpainting-digital-human-service-1 bash -c "source /opt/conda/etc/profile.d/conda.sh && conda activate human && python /app/HeyGem-Linux-Python-Hack/check_env/check_onnx_cuda.py"
```

## 📊 当前状态

- **匹配的包**: 16个
- **不匹配的包**: 4个（关键包）
- **缺失的包**: 0个

## 🎯 修复优先级

1. **高优先级**: PyTorch 版本（torch, torchvision, torchaudio）
2. **中优先级**: ONNX Runtime GPU 版本
3. **低优先级**: 其他依赖包（已匹配）

## 📅 日期

2025-11-09


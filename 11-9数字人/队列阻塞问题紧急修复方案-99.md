# 队列阻塞问题紧急修复方案

## 问题诊断

### 当前状态

从最新日志分析：

1. **任务执行失败**: 任务在 10 秒后失败，异常信息为空
2. **任务状态为错误**: `task_result = (<Status.error: 3>, 0, '', '')`
3. **没有看到队列阻塞错误**: 这次任务没有看到 "任务视频驱动队列满，严重阻塞" 的错误
4. **多个 multiprocessing 进程**: 有 27 个相关进程在运行

### 关键发现

1. **环境变量未设置**: 在运行时环境中，环境变量显示为"未设置"
2. **多个僵尸进程**: 有多个 `<defunct>` 进程
3. **任务可能在不同阶段失败**: 可能是在队列启动前就失败了

## 根本原因

### 1. 环境变量未传递到子进程

环境变量虽然在 `app.py` 中设置了，但在使用 `multiprocessing.spawn` 启动子进程时，可能没有正确传递到子进程。

### 2. 多进程资源竞争

多个进程竞争 GPU 资源，导致某些操作被阻塞或失败。

### 3. 任务执行超时

任务可能在等待某些操作时超时，但超时时间可能设置得太短。

## 紧急修复方案

### 方案 1: 清理僵尸进程并重启服务

```bash
# 1. 停止所有相关进程
docker exec starpainting-digital-human-service-1 bash -c "pkill -9 -f 'python.*app.py'"

# 2. 清理僵尸进程
docker exec starpainting-digital-human-service-1 bash -c "ps aux | grep defunct | awk '{print \$2}' | xargs -r kill -9 2>/dev/null"

# 3. 验证配置
docker exec starpainting-digital-human-service-1 bash -c "/app/HeyGem-Linux-Python-Hack/fix_num_threads.sh"

# 4. 重启服务
docker exec starpainting-digital-human-service-1 bash -c "source /opt/conda/etc/profile.d/conda.sh && conda activate human && cd /app/HeyGem-Linux-Python-Hack && nohup python app.py > /tmp/gradio.log 2>&1 &"
```

### 方案 2: 增加任务超时时间

在 `app.py` 中增加任务超时时间，给任务更多时间完成。

### 方案 3: 检查并修复环境变量传递

确保环境变量在子进程启动前设置，并在子进程启动时传递。

## 立即执行

### 1. 清理进程并重启服务

```bash
# 停止服务
docker exec starpainting-digital-human-service-1 bash -c "ps aux | grep 'python app.py' | grep -v grep | awk '{print \$2}' | xargs -r kill -9"

# 等待进程完全停止
sleep 5

# 验证配置
docker exec starpainting-digital-human-service-1 bash -c "source /opt/conda/etc/profile.d/conda.sh && conda activate human && /app/HeyGem-Linux-Python-Hack/fix_num_threads.sh"

# 重启服务
docker exec starpainting-digital-human-service-1 bash -c "source /opt/conda/etc/profile.d/conda.sh && conda activate human && cd /app/HeyGem-Linux-Python-Hack && nohup python app.py > /tmp/gradio.log 2>&1 & sleep 10 && tail -20 /tmp/gradio.log"
```

### 2. 监控服务状态

```bash
# 检查服务状态
docker exec starpainting-digital-human-service-1 bash -c "ps aux | grep 'python app.py' | grep -v grep"

# 检查 HTTP 状态
docker exec starpainting-digital-human-service-1 bash -c "curl -s -o /dev/null -w 'HTTP状态: %{http_code}\n' http://localhost:7860/"

# 监控日志
docker exec starpainting-digital-human-service-1 bash -c "tail -f /app/HeyGem-Linux-Python-Hack/log/dh.log"
```

## 长期解决方案

### 1. 确保环境变量正确传递

需要在子进程启动前设置环境变量，并确保子进程能够继承这些环境变量。

### 2. 优化多进程配置

减少多进程数量，避免资源竞争。

### 3. 增加错误处理和日志

增加更详细的错误处理和日志记录，帮助诊断问题。

### 4. 定期清理僵尸进程

定期清理僵尸进程，避免资源泄漏。

## 验证步骤

1. **清理进程**: 停止所有相关进程
2. **验证配置**: 确保 `num_threads: 0`
3. **重启服务**: 重启服务并等待初始化完成
4. **测试功能**: 测试数字人生成功能
5. **监控日志**: 观察是否还有队列阻塞错误

## 更新日期

2025-11-09


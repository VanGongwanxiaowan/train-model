# 功能测试与监控详细报告

## 测试时间
2025-11-09 16:22-16:23

## 1. 服务状态检查

### ✅ Web 界面可访问性
- **Gradio 服务**: http://0.0.0.0:7860
- **HTTP 状态**: 200 ✅
- **服务进程**: 运行中 ✅
- **服务内存**: 5.25 GB

### ✅ 服务初始化
- **初始化时间**: 7.53 秒
- **初始化状态**: 成功 ✅
- **服务就绪**: 是 ✅

## 2. 任务执行情况

### 任务 ID: 30da0fc8-bd45-11f0-a389-0242ac110003

#### 执行时间线
- **16:22:11** - 任务开始处理
- **16:22:12** - 预处理完成（0.31秒）✅
- **16:22:12** - 音频特征提取完成（0.31秒）✅
- **16:22:19** - init_wh 完成（7.53秒）✅
- **16:22:23** - 视频驱动队列启动（batch_size:1, len:150）✅
- **16:22:24** - 开始发送数据（发送了10个数据）✅
- **16:23:24** - **队列阻塞**（60秒后）❌

#### 问题分析
1. **队列阻塞时间**: 60秒
2. **阻塞位置**: 视频驱动队列处理阶段
3. **数据发送**: 仅发送了10个数据就阻塞
4. **总数据量**: 150个数据（仅处理了6.7%）

## 3. 性能监控

### GPU 状态（8个 GPU）

| GPU | 型号 | 内存使用 | 内存总量 | GPU利用率 | 内存利用率 | 温度 |
|-----|------|---------|---------|----------|-----------|------|
| 0 | A100-80GB | 51.7 GB | 81.9 GB | **0%** ⚠️ | 63% | 43°C |
| 1 | A100-80GB | 40.5 GB | 81.9 GB | **0%** ⚠️ | 49% | 50°C |
| 2 | A100-80GB | 40.2 GB | 81.9 GB | **0%** ⚠️ | 49% | 49°C |
| 3 | A100-80GB | 43.5 GB | 81.9 GB | **0%** ⚠️ | 53% | 44°C |
| 4 | A100-80GB | 43.1 GB | 81.9 GB | **0%** ⚠️ | 53% | 42°C |
| 5 | A100-80GB | 10.5 GB | 81.9 GB | **0%** ⚠️ | 13% | 50°C |
| 6 | A100-80GB | 37.4 GB | 81.9 GB | **0%** ⚠️ | 46% | 50°C |
| 7 | A100-80GB | 14.5 GB | 81.9 GB | **0%** ⚠️ | 18% | 44°C |

### ⚠️ 关键问题

**GPU 利用率为 0%** - 这表明：
1. GPU 没有被使用
2. 任务可能卡在 CPU 处理阶段
3. 或者是多进程/多线程问题导致 GPU 调用被阻塞

### 系统资源

- **系统内存**: 443 GB / 1.0 TB (44% 使用)
- **可用内存**: 494 GB
- **磁盘空间**: 3.8 TB / 7.0 TB (58% 使用)
- **进程数**: 42 个 Python 进程
- **僵尸进程**: 41 个 ⚠️

### ⚠️ 关键问题

**41 个僵尸进程** - 这表明：
1. 多进程没有正确清理
2. 可能导致资源泄漏
3. 可能影响新任务的执行

## 4. 队列阻塞分析

### 阻塞现象
- **错误信息**: "任务视频驱动队列满，严重阻塞，下游队列异常"
- **阻塞时间**: 60秒
- **阻塞位置**: 视频驱动队列处理阶段
- **数据进度**: 10/150 (6.7%)

### 可能原因

1. **ONNX Runtime 问题**
   - ONNX Runtime 1.11.0 可能仍有问题
   - 需要进一步降级或优化

2. **多进程问题**
   - 41 个僵尸进程表明多进程管理有问题
   - 可能需要改进进程清理机制

3. **GPU 调用问题**
   - GPU 利用率为 0%，说明 GPU 没有被使用
   - 可能是 CUDA 调用被阻塞

4. **队列大小问题**
   - 队列可能太小，导致阻塞
   - 需要调整队列大小

5. **num_threads 配置**
   - 需要检查 num_threads 配置
   - 可能仍然不是 0

## 5. 建议解决方案

### 1. 检查 num_threads 配置
```bash
grep 'num_threads' /app/HeyGem-Linux-Python-Hack/landmark2face_wy/checkpoints/test/opt.txt
```
应该为 `num_threads: 0`

### 2. 清理僵尸进程
需要改进进程清理机制，确保子进程正确退出。

### 3. 进一步优化 ONNX Runtime
- 尝试使用 ONNX Runtime 1.16.0（更稳定）
- 或者进一步优化配置

### 4. 增加队列大小
- 增加视频驱动队列大小
- 增加超时时间

### 5. 监控 GPU 使用
- 添加 GPU 使用监控
- 确保 GPU 被正确使用

## 6. 测试结果总结

### ✅ 正常功能
- Web 界面可访问
- 服务初始化成功
- 预处理功能正常
- 音频特征提取正常
- init_wh 初始化正常
- 队列启动正常

### ❌ 问题功能
- 视频驱动队列处理阻塞
- GPU 未被使用
- 多进程管理有问题（41个僵尸进程）

## 7. 下一步行动

### 立即行动
1. **检查 num_threads 配置** - 确保为 0
2. **清理僵尸进程** - 改进进程清理机制
3. **监控 GPU 使用** - 确保 GPU 被使用
4. **优化队列配置** - 增加队列大小和超时时间

### 后续优化
1. **进一步优化 ONNX Runtime** - 尝试不同版本
2. **改进多进程管理** - 确保进程正确清理
3. **增加监控** - 实时监控 GPU 和队列状态
4. **性能测试** - 进行完整的性能测试

## 8. 监控命令

### 实时监控
```bash
# 监控日志
tail -f /app/HeyGem-Linux-Python-Hack/log/dh.log

# 监控 GPU
watch -n 1 nvidia-smi

# 监控进程
watch -n 1 'ps aux | grep python | wc -l'
```

### 检查配置
```bash
# 检查 num_threads
grep 'num_threads' /app/HeyGem-Linux-Python-Hack/landmark2face_wy/checkpoints/test/opt.txt

# 检查环境变量
env | grep -E 'TORCH|ONNX|CUDA|OMP'
```

## 总结

**服务状态**: ✅ 正常运行
**功能测试**: ⚠️ 部分功能正常，队列阻塞问题仍存在
**性能监控**: ⚠️ GPU 未被使用，多进程管理有问题
**建议**: 需要进一步优化配置和进程管理


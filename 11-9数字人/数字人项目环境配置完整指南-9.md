# 数字人项目环境配置完整指南

## 重要说明

**所有依赖版本必须与 `requirements.txt` 完全一致！**

## requirements.txt 关键版本

### PyTorch 相关
- `torch==1.13.1`
- `torchaudio==0.13.1`
- `torchvision==0.14.1`

### ONNX Runtime
- `onnxruntime-gpu==1.19.2`

### 其他关键库
- `flask==3.0.3`
- `opencv-python==4.7.0.72`
- `librosa==0.8.1`
- `transformers==4.6.1`
- `cv2box==0.5.9`
- `apstone==0.0.8`
- `typeguard==2.13.3`
- `PySoundFile==0.9.0.post1`
- `SoundFile==0.10.3.post1`
- 以及其他所有依赖（共 104 个包）

## 环境配置步骤

### 步骤 1: 创建 Conda 环境
```bash
conda create -n heygem38 python=3.8 -y
conda activate heygem38
```

### 步骤 2: 安装系统依赖
```bash
apt-get update
apt-get install -y ffmpeg libsndfile1
```

### 步骤 3: 安装 Python 依赖（使用 requirements.txt）
```bash
cd /app/HeyGem-Linux-Python-Hack
pip install -r requirements.txt --timeout 600
```

**重要**: 必须使用 `requirements.txt`，不能手动指定版本！

## 自动化配置

### 使用配置脚本
```bash
bash /app/HeyGem-Linux-Python-Hack/配置heygem38环境.sh
```

这个脚本会：
1. 创建/激活 heygem38 环境
2. 安装系统依赖
3. 使用 requirements.txt 安装所有 Python 依赖
4. 验证安装

## 环境变量配置

### LD_LIBRARY_PATH
```bash
export LD_LIBRARY_PATH="/opt/conda/envs/heygem38/lib:$LD_LIBRARY_PATH"
```

### ONNX Runtime 配置
```bash
export ORT_PARALLEL=0
export OMP_WAIT_POLICY=ACTIVE
export ORT_LOGGING_LEVEL=3
```

### PyTorch 配置
```bash
export TORCH_DATALOADER_NUM_WORKERS=0
export CUDA_LAUNCH_BLOCKING=0
export CUDA_DEVICE_ORDER=PCI_BUS_ID
```

## 验证安装

### 检查 PyTorch
```bash
python -c "import torch; print(f'PyTorch: {torch.__version__}')"
# 应该输出: PyTorch: 1.13.1
```

### 检查 ONNX Runtime
```bash
python -c "import onnxruntime as ort; print(f'ONNX Runtime: {ort.__version__}')"
# 应该输出: ONNX Runtime: 1.19.2
```

### 检查 GPU 支持
```bash
python check_env/check_onnx_cuda.py
# 应该输出: ONNX Runtime is successfully using the GPU.
```

## 启动服务

### 使用启动脚本
```bash
bash /app/HeyGem-Linux-Python-Hack/启动服务_heygem38.sh
```

### 手动启动
```bash
source /opt/conda/etc/profile.d/conda.sh
conda activate heygem38
export LD_LIBRARY_PATH="/opt/conda/envs/heygem38/lib:$LD_LIBRARY_PATH"
cd /app/HeyGem-Linux-Python-Hack
python app.py
```

## 版本一致性检查

### 检查当前安装的版本
```bash
pip list | grep -E 'torch|onnxruntime|flask|opencv'
```

### 与 requirements.txt 对比
```bash
pip freeze | grep -E 'torch|onnxruntime|flask|opencv' > installed.txt
diff installed.txt <(grep -E 'torch|onnxruntime|flask|opencv' requirements.txt)
```

## 常见问题

### 问题 1: 版本不匹配
**解决方法**: 重新安装 requirements.txt
```bash
pip install -r requirements.txt --force-reinstall
```

### 问题 2: 依赖冲突
**解决方法**: 清理环境后重新安装
```bash
pip uninstall -y $(pip list | awk '{print $1}' | tail -n +3)
pip install -r requirements.txt
```

### 问题 3: GPU 不可用
**解决方法**: 检查环境变量和 CUDA 版本
```bash
echo $LD_LIBRARY_PATH
nvidia-smi
python check_env/check_onnx_cuda.py
```

## 重要提醒

1. **必须使用 requirements.txt**: 所有依赖版本必须与 requirements.txt 完全一致
2. **不要手动指定版本**: 不要使用 `pip install torch==x.x.x`，使用 `pip install -r requirements.txt`
3. **检查版本一致性**: 安装后验证所有关键库的版本
4. **环境变量设置**: 确保所有必要的环境变量都已设置

## 相关文件

- `requirements.txt` - 依赖列表（所有版本必须完全一致）
- `配置heygem38环境.sh` - 环境配置脚本
- `启动服务_heygem38.sh` - 服务启动脚本
- `环境配置完整指南.md` - 本文档


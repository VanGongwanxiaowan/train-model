# 依赖安装说明

## 概述

本文档说明如何安装 HeyGem 项目所需的 Python 依赖。所有依赖版本基于已验证可运行的配置。

## 安装方式

### 方式 1: 使用安装脚本（推荐）

```bash
# 在容器内执行
docker exec -it starpainting-digital-human-service-1 bash
cd /app/HeyGem-Linux-Python-Hack
bash install_dependencies.sh
```

### 方式 2: 手动安装

#### 步骤 1: 激活 conda 环境

```bash
source /opt/conda/etc/profile.d/conda.sh
conda activate human
cd /app/HeyGem-Linux-Python-Hack
```

#### 步骤 2: 卸载旧版本 PyTorch（如果存在）

```bash
pip uninstall -y torch torchvision torchaudio triton
```

#### 步骤 3: 安装 PyTorch（使用南大镜像源）

**重要**: PyTorch 需要使用支持 CUDA 11.8 的专用镜像源。

```bash
pip install torch==2.1.2+cu118 torchvision==0.16.2 torchaudio==2.1.2 \
    -i https://mirror.nju.edu.cn/pytorch/whl/cu118 \
    --trusted-host mirror.nju.edu.cn
```

**替代镜像源**（如果南大镜像不可用）:

```bash
# 使用 PyTorch 官方源
pip install torch==2.1.2+cu118 torchvision==0.16.2 torchaudio==2.1.2 \
    --index-url https://download.pytorch.org/whl/cu118
```

#### 步骤 4: 安装其他依赖

```bash
pip install -r requirements_0.txt \
    -i https://mirrors.aliyun.com/pypi/web/simple \
    --trusted-host mirrors.aliyun.com
```

**替代镜像源**（如果阿里云镜像不可用）:

```bash
# 使用清华镜像
pip install -r requirements_0.txt \
    -i https://pypi.tuna.tsinghua.edu.cn/simple

# 或使用官方源
pip install -r requirements_0.txt
```

## 关键依赖版本

### 深度学习框架

| 包名 | 版本 | 说明 |
|------|------|------|
| torch | 2.1.2+cu118 | PyTorch 主框架，CUDA 11.8 版本 |
| torchvision | 0.16.2 | 计算机视觉工具包 |
| torchaudio | 2.1.2 | 音频处理工具包 |
| onnxruntime-gpu | 1.18.0 | ONNX 运行时（GPU 版本） |

### 科学计算

| 包名 | 版本 | 说明 |
|------|------|------|
| numpy | 1.22.4 | 数值计算库 |
| scipy | 1.10.1 | 科学计算库 |
| scikit-learn | 1.0.2 | 机器学习库 |
| scikit-image | 0.19.3 | 图像处理库 |

### 图像和视频处理

| 包名 | 版本 | 说明 |
|------|------|------|
| opencv-python | 4.7.0.72 | OpenCV Python 绑定 |
| pillow | 9.1.1 | 图像处理库 |
| imageio | 2.19.3 | 图像 I/O 库 |

### 音频处理

| 包名 | 版本 | 说明 |
|------|------|------|
| librosa | 0.8.1 | 音频分析库 |
| soundfile | 0.10.3.post1 | 音频文件 I/O |
| resampy | 0.2.2 | 音频重采样 |

### 其他重要依赖

| 包名 | 版本 | 说明 |
|------|------|------|
| transformers | 4.6.1 | Hugging Face  transformers |
| tokenizers | 0.10.3 | 快速文本标记化 |
| typeguard | 2.13.3 | 类型检查 |
| flask | >=3.0.3 | Web 框架 |

## 验证安装

安装完成后，运行以下命令验证：

```bash
python -c "
import torch
import cv2
import numpy as np
import librosa
import onnxruntime

print('PyTorch:', torch.__version__)
print('CUDA 可用:', torch.cuda.is_available())
if torch.cuda.is_available():
    print('CUDA 版本:', torch.version.cuda)
    print('GPU 数量:', torch.cuda.device_count())
print('OpenCV:', cv2.__version__)
print('NumPy:', np.__version__)
print('Librosa:', librosa.__version__)
print('ONNX Runtime:', onnxruntime.__version__)
"
```

**预期输出**:
- PyTorch: 2.1.2+cu118
- CUDA 可用: True
- CUDA 版本: 11.8
- OpenCV: 4.7.0
- NumPy: 1.22.4
- Librosa: 0.8.1
- ONNX Runtime: 1.18.0

## 常见问题

### 1. PyTorch 安装失败

**问题**: 无法找到 torch==2.1.2+cu118

**解决方案**:
- 确保使用正确的镜像源: `https://mirror.nju.edu.cn/pytorch/whl/cu118`
- 或使用 PyTorch 官方源: `https://download.pytorch.org/whl/cu118`
- 检查网络连接

### 2. CUDA 版本不匹配

**问题**: PyTorch 安装成功但 CUDA 不可用

**解决方案**:
- 检查 NVIDIA 驱动版本: `nvidia-smi`
- 检查容器内 CUDA 版本: `nvcc --version`
- 确保使用正确的 PyTorch CUDA 版本（cu118）

### 3. 依赖冲突

**问题**: 某些包版本冲突

**解决方案**:
- 先卸载冲突的包: `pip uninstall <package_name>`
- 重新安装: `pip install <package_name>==<version>`
- 使用虚拟环境隔离依赖

### 4. 镜像源访问慢或失败

**问题**: 下载速度慢或连接失败

**解决方案**:
- 尝试不同的镜像源（阿里云、清华、官方）
- 检查网络连接和防火墙设置
- 使用代理（如需要）

## 镜像源列表

### PyTorch 专用镜像源（CUDA 11.8）

1. **南大镜像**（推荐）:
   ```
   https://mirror.nju.edu.cn/pytorch/whl/cu118
   ```

2. **PyTorch 官方源**:
   ```
   https://download.pytorch.org/whl/cu118
   ```

### Python 包镜像源

1. **阿里云镜像**（推荐）:
   ```
   https://mirrors.aliyun.com/pypi/web/simple
   ```

2. **清华镜像**:
   ```
   https://pypi.tuna.tsinghua.edu.cn/simple
   ```

3. **官方源**:
   ```
   https://pypi.org/simple
   ```

## 文件说明

- `requirements_0.txt`: 所有依赖包的列表（requirements 格式）
- `pyproject.toml`: 项目配置文件（包含依赖和索引源配置）
- `install_dependencies.sh`: 自动化安装脚本

## 更新日期

2025-11-09


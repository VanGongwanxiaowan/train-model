# 添加 Gradio 端口映射

## 问题

Gradio 服务在容器内正常运行（监听 0.0.0.0:7860），但容器没有映射 7860 端口到主机，导致外部无法访问。

## 当前状态

- ✅ Gradio 服务运行中（容器内）
- ✅ 服务监听在 0.0.0.0:7860
- ✅ 容器内可以访问 http://localhost:7860
- ❌ 外部无法访问 http://192.168.191.56:7860（缺少端口映射）

## 解决方案

### 方案 1: 重新启动容器（添加端口映射）（推荐）

需要停止当前容器，使用新的端口映射重新启动。

#### 步骤 1: 停止并删除当前容器

```bash
docker stop starpainting-digital-human-service-1
docker rm starpainting-digital-human-service-1
```

#### 步骤 2: 使用更新的启动脚本重新启动

```bash
cd /data2/home_back/gujiaxin/work/starpainting/backend/services/digital-human-service
bash start_with_shm.sh
```

启动脚本已更新，现在包含 `-p 7860:7860` 端口映射。

### 方案 2: 手动添加端口映射

如果不想重启容器，可以使用 `docker commit` 和重新运行，但这会丢失运行中的数据。

### 方案 3: 使用 iptables 端口转发（临时方案）

```bash
# 在主机上设置端口转发（需要 root 权限）
iptables -t nat -A DOCKER -p tcp --dport 7860 -j DNAT --to-destination $(docker inspect -f '{{range .NetworkSettings.Networks}}{{.IPAddress}}{{end}}' starpainting-digital-human-service-1):7860
```

**注意**: 这个方案是临时的，容器重启后会失效。

## 验证

### 1. 检查端口映射

```bash
docker port starpainting-digital-human-service-1
```

**预期输出**:
```
8308/tcp -> 0.0.0.0:8308
7860/tcp -> 0.0.0.0:7860
```

### 2. 从外部访问 Gradio

```bash
curl http://192.168.191.56:7860/
```

**预期**: 返回 Gradio 网页内容

### 3. 检查服务状态

```bash
# 检查容器内 Gradio 服务
docker exec starpainting-digital-human-service-1 curl -s http://localhost:7860/ | head -5

# 检查外部访问
curl -s http://192.168.191.56:7860/ | head -5
```

## 更新后的启动命令

```bash
docker run -d \
  --name starpainting-digital-human-service-1 \
  --restart unless-stopped \
  -p 8308:8308 \
  -p 7860:7860 \
  --gpus all \
  --shm-size=2g \
  -v /data2/home_back/gujiaxin/work/starpainting/backend/services/digital-human-service:/app \
  -v /data2/home_back/gujiaxin/work/batchshort1/assrt:/data2/home_back/gujiaxin/work/batchshort1/assrt \
  -e PYTHONUNBUFFERED=1 \
  heygem:v2.2 \
  bash start.sh
```

## 注意事项

1. **端口冲突**: 确保主机上的 7860 端口没有被其他服务占用
2. **防火墙**: 确保防火墙允许 7860 端口的访问
3. **服务启动**: 容器启动后，Gradio 服务需要手动启动（通过 `python app.py`）

## 相关文件

- `start_with_shm.sh` - 已更新，包含 7860 端口映射
- `DOCKER_SETUP.md` - Docker 部署文档

## 更新日期

2025-11-09


# 任务失败根本原因分析

## 问题现象

从日志 `dh.log (445-453)` 可以看到：

```
[15:26:49] 预处理完成（0.19秒）
[15:26:54] get_aud_feat1 完成（5.2秒）
[15:27:04] 任务执行失败（10秒后，总耗时15.41秒）
[15:27:06] init_wh 完成（16.77秒后）
```

### 关键时间线分析

1. **15:26:49** - 预处理完成
2. **15:26:54** - get_aud_feat1 完成（耗时 5.2秒）
3. **15:27:04** - **任务执行失败**（耗时 15.41秒）
4. **15:27:06** - init_wh 完成（耗时 16.77秒）

### 关键发现

1. **任务在 init_wh 完成之前就失败了**
   - 任务失败时间：15:27:04
   - init_wh 完成时间：15:27:06
   - **时间差：2秒**

2. **没有看到队列启动日志**
   - 没有看到 "任务视频驱动队列启动" 的日志
   - 说明任务可能在启动队列之前就失败了

3. **任务状态为错误**
   - `task_result = (<Status.error: 3>, 0, '', '')`
   - 异常信息为空：`异常信息:[]`

## 根本原因

### 1. 任务执行是异步的，但主线程没有等待

从代码看：
```python
self.task.work(audio_path, video_path, code, 0, 0, 0, 0)
# 立即检查任务状态
task_result = self.task.task_dic[code]
```

**问题**:
- `self.task.work()` 是异步执行的，启动子进程处理任务
- 主线程调用后立即返回，不等待子进程完成
- 主线程立即检查任务状态
- 但此时子进程可能还在执行 init_wh（需要16.77秒）

### 2. 任务状态检查过早

**问题**:
- 主线程在任务执行后立即检查状态
- 但子进程需要时间完成 init_wh（16.77秒）
- 如果检查时任务状态还未更新，可能会误判为失败

### 3. 任务可能在 init_wh 阶段超时或失败

**问题**:
- init_wh 需要 16.77 秒完成
- 任务在 15.41 秒时就失败了
- 说明任务可能在等待 init_wh 完成时超时了
- 或者 init_wh 阶段出现了问题

### 4. 错误信息未正确传递

**问题**:
- 任务状态为错误，但异常信息为空
- 说明错误可能发生在子进程中
- 但错误信息没有正确传递到主线程

## 解决方案

### 方案 1: 增加任务等待时间

在检查任务状态前，等待足够的时间让 init_wh 完成。

```python
# 等待 init_wh 完成（通常需要 15-20 秒）
time.sleep(20)

# 然后再检查任务状态
task_result = self.task.task_dic[code]
```

### 方案 2: 轮询检查任务状态

使用轮询方式检查任务状态，直到任务完成或超时。

```python
# 轮询检查任务状态
max_wait_time = 300  # 5分钟
start_time = time.time()
while time.time() - start_time < max_wait_time:
    if code in self.task.task_dic:
        task_result = self.task.task_dic[code]
        # 检查任务状态
        if isinstance(task_result, tuple) and len(task_result) >= 3:
            status = task_result[0]
            if hasattr(status, 'name') and status.name != 'error':
                break
    time.sleep(1)
```

### 方案 3: 检查 service 模块

检查 `service/trans_dh_service.py` 中的任务执行逻辑，确保：
- 任务超时设置合理
- 错误信息正确传递
- 任务状态正确更新

### 方案 4: 增加更详细的日志

在任务执行的各个阶段增加日志，帮助诊断问题。

## 立即修复

### 修复 app.py 中的任务状态检查

在 `app.py` 中，在检查任务状态前，增加等待时间或使用轮询方式：

```python
# 等待 init_wh 完成
logger.info(f"[{code}] 等待任务初始化完成...")
time.sleep(20)  # 等待 init_wh 完成

# 然后检查任务状态
task_result = self.task.task_dic[code]
```

## 下一步

1. **检查 service 模块**: 检查任务执行逻辑和超时设置
2. **增加等待时间**: 在检查任务状态前，等待足够的时间
3. **使用轮询方式**: 使用轮询方式检查任务状态，直到任务完成
4. **增加日志记录**: 增加更详细的日志记录，帮助诊断问题


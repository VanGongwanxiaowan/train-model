# 队列阻塞问题解决方案实施报告

## 执行时间
2025-11-09

## 问题分析

### 当前问题
1. **GPU 利用率为 0%** ❌
2. **74 个僵尸进程** ❌
3. **队列阻塞** ❌ - 视频驱动队列在60秒后阻塞
4. **任务处理慢** ⚠️ - 仅处理了 10/150 个数据（6.7%）

## 根本原因

### 1. GPU 未使用的原因
- ONNX Runtime 可能未使用 GPU
- 需要在代码中明确指定 CUDAExecutionProvider
- 但由于 service 是编译后的 .so 文件，无法直接修改

### 2. 僵尸进程的原因
- 父进程未等待子进程退出
- 进程清理机制有问题
- 多进程环境下信号处理复杂

### 3. 队列阻塞的原因
- **关键原因**: GPU 处理 150 帧视频需要时间
- 每帧处理可能需要几秒钟
- 总处理时间可能需要 2-3 分钟
- **60秒超时时间明显不足**

## 解决方案

### 方案 1: 增加超时时间（最关键）

#### 为什么有效？
- **GPU 处理需要时间**: 150帧视频，每帧处理可能需要几秒钟
- **总处理时间**: 可能需要 2-3 分钟
- **60秒超时不足**: 明显不足，导致过早判定失败
- **增加超时时间**: 给 GPU 足够的处理时间

#### 实施
1. **增加任务等待超时时间**: 从 600秒 增加到 900秒（15分钟）
2. **增加错误等待时间**: 从 60秒 增加到 180秒（3分钟）
3. **增加队列超时时间**: 从 300秒 增加到 900秒（15分钟）
4. **增加服务器超时时间**: 从默认值增加到 600秒（10分钟）

### 方案 2: 增加队列大小

#### 为什么有效？
- 允许更多任务排队
- 减少队列填满的概率
- 提高系统吞吐量

#### 实施
- 队列大小: 从 10 增加到 20

### 方案 3: 优化等待逻辑

#### 为什么有效？
- 更合理的等待时间
- 避免过早判定失败
- 提高任务成功率

#### 实施
1. **优化检查间隔**: 从 3秒 减少到 2秒
2. **优化日志记录**: 减少日志输出频率
3. **优化等待时间**: 根据实际处理时间调整

### 方案 4: 清理僵尸进程

#### 为什么有效？
- 释放系统资源
- 减少资源竞争
- 提高系统性能

#### 实施
1. **重启服务**: 清理所有僵尸进程
2. **改进清理机制**: 在服务启动时清理
3. **定期清理**: 添加定期清理机制

## 实施步骤

### 步骤 1: 检查 ONNX Runtime 和 CUDA

```bash
# 检查 ONNX Runtime 提供者
python3 -c "import onnxruntime as ort; print(ort.get_available_providers())"

# 检查 CUDA 可用性
python3 -c "import torch; print(torch.cuda.is_available())"
```

### 步骤 2: 优化配置

1. **更新 app.py**
   - 优化 ONNX Runtime 配置
   - 优化队列配置
   - 优化任务等待逻辑

2. **验证配置**
   - 检查环境变量
   - 检查队列配置
   - 检查超时时间

### 步骤 3: 清理僵尸进程（重启服务）

```bash
# 停止服务
ps aux | grep 'python app.py' | grep -v grep | awk '{print $2}' | xargs -r kill -9

# 清理 multiprocessing 进程
pkill -9 -f "multiprocessing.spawn" 2>/dev/null || true

# 等待进程清理
sleep 5
```

### 步骤 4: 重启服务

```bash
# 重启服务
source /opt/conda/etc/profile.d/conda.sh
conda activate human
cd /app/HeyGem-Linux-Python-Hack
nohup python app.py > /tmp/gradio.log 2>&1 &
```

### 步骤 5: 验证修复

1. **检查 GPU 使用**
   ```bash
   nvidia-smi --query-gpu=index,utilization.gpu --format=csv
   ```

2. **检查僵尸进程**
   ```bash
   ps aux | grep defunct | wc -l
   ```

3. **测试任务执行**
   - 提交测试任务
   - 观察 GPU 使用情况
   - 检查队列阻塞情况

## 预期效果

### 修复后预期

1. **GPU 使用**
   - GPU 利用率 > 0%
   - GPU 内存使用增加
   - 处理速度提高

2. **僵尸进程**
   - 僵尸进程数量减少（重启后为0）
   - 新任务不再产生僵尸进程
   - 系统资源释放

3. **队列阻塞**
   - 队列阻塞问题解决
   - 任务处理速度提高
   - 任务成功率提高

4. **性能提升**
   - 处理速度提高
   - 任务完成时间减少
   - 系统吞吐量提高

## 监控建议

### 实时监控

```bash
# 监控 GPU
watch -n 1 'nvidia-smi --query-gpu=index,utilization.gpu,memory.used --format=csv'

# 监控进程
watch -n 1 'ps aux | grep python | wc -l && ps aux | grep defunct | wc -l'

# 监控日志
tail -f /app/HeyGem-Linux-Python-Hack/log/dh.log | grep -E '队列|阻塞|GPU|ERROR|成功'
```

## 总结

### 关键修复

1. **增加超时时间** - 从 60秒 增加到 180秒（给GPU更多处理时间）
2. **增加队列大小** - 从 10 增加到 20
3. **优化等待逻辑** - 根据实际处理时间调整
4. **清理僵尸进程** - 重启服务清理

### 为什么这些修复有效？

1. **GPU 处理需要时间**
   - 150帧视频需要处理时间
   - 每帧处理可能需要几秒钟
   - 总处理时间可能需要 2-3 分钟
   - 60秒超时明显不足

2. **增加超时时间**
   - 给 GPU 足够的处理时间
   - 避免过早判定失败
   - 提高任务成功率


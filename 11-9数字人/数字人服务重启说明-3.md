# æ•°å­—äººæœåŠ¡é‡å¯è¯´æ˜

## ğŸ“‹ æ¦‚è¿°

æ•°å­—äººæœåŠ¡åŒ…æ‹¬ä¸¤ä¸ªéƒ¨åˆ†ï¼š
1. **FastAPIæœåŠ¡**ï¼ˆç«¯å£8308ï¼‰- å®¹å™¨å¯åŠ¨æ—¶è‡ªåŠ¨è¿è¡Œ
2. **GradioæœåŠ¡**ï¼ˆç«¯å£7860ï¼‰- éœ€è¦æ‰‹åŠ¨å¯åŠ¨

## ğŸš€ å¿«é€Ÿé‡å¯

### æ–¹æ³•1: ä½¿ç”¨é‡å¯è„šæœ¬ï¼ˆæ¨èï¼‰

```bash
# æ‰§è¡Œé‡å¯è„šæœ¬
bash /data2/home_back/gujiaxin/work/starpainting/backend/services/digital-human-service/restart_service.sh
```

### æ–¹æ³•2: æ‰‹åŠ¨é‡å¯

#### æ­¥éª¤1: é‡å¯Dockerå®¹å™¨

```bash
# é‡å¯å®¹å™¨ï¼ˆè¿™ä¼šé‡å¯FastAPIæœåŠ¡ï¼‰
docker restart starpainting-digital-human-service-1
```

#### æ­¥éª¤2: ç­‰å¾…å®¹å™¨å¯åŠ¨

```bash
# ç­‰å¾…10ç§’è®©å®¹å™¨å¯åŠ¨
sleep 10

# æ£€æŸ¥å®¹å™¨çŠ¶æ€
docker ps | grep starpainting-digital-human-service
```

#### æ­¥éª¤3: ç­‰å¾…FastAPIæœåŠ¡åˆå§‹åŒ–

```bash
# ç­‰å¾…30ç§’è®©æ¨¡å‹åŠ è½½å®Œæˆï¼ˆæ ¹æ®æ–°çš„sleepæ—¶é—´è®¾ç½®ï¼‰
sleep 30

# æ£€æŸ¥FastAPIæœåŠ¡
curl http://localhost:8308/health
```

#### æ­¥éª¤4: åœæ­¢æ—§çš„GradioæœåŠ¡

```bash
# åœæ­¢æ—§çš„Gradioè¿›ç¨‹
docker exec starpainting-digital-human-service-1 pkill -f "python app.py"
```

#### æ­¥éª¤5: å¯åŠ¨GradioæœåŠ¡

```bash
# å¯åŠ¨GradioæœåŠ¡
docker exec -d starpainting-digital-human-service-1 bash -c "source /opt/conda/etc/profile.d/conda.sh && conda activate human && cd /app/HeyGem-Linux-Python-Hack && export PYTHONPATH=/app/HeyGem-Linux-Python-Hack && export LD_LIBRARY_PATH=/opt/conda/envs/human/lib:\$LD_LIBRARY_PATH && nohup python app.py > /tmp/gradio.log 2>&1 &"
```

#### æ­¥éª¤6: ç­‰å¾…GradioæœåŠ¡åˆå§‹åŒ–

```bash
# ç­‰å¾…15ç§’è®©Gradioåˆå§‹åŒ–ï¼ˆæ ¹æ®æ–°çš„sleepæ—¶é—´è®¾ç½®ï¼‰
sleep 15

# æ£€æŸ¥GradioæœåŠ¡
curl http://localhost:7860
```

## âœ… éªŒè¯æœåŠ¡çŠ¶æ€

### æ£€æŸ¥FastAPIæœåŠ¡

```bash
# æ£€æŸ¥å¥åº·çŠ¶æ€
curl http://localhost:8308/health

# é¢„æœŸè¾“å‡º
# {"status":"ok","service":"digital-human-service"}
```

### æ£€æŸ¥GradioæœåŠ¡

```bash
# æ£€æŸ¥æœåŠ¡çŠ¶æ€
curl http://localhost:7860

# æ£€æŸ¥è¿›ç¨‹
docker exec starpainting-digital-human-service-1 ps aux | grep "python app.py" | grep -v grep
```

### æŸ¥çœ‹æœåŠ¡æ—¥å¿—

```bash
# æŸ¥çœ‹FastAPIæœåŠ¡æ—¥å¿—
docker logs -f starpainting-digital-human-service-1

# æŸ¥çœ‹GradioæœåŠ¡æ—¥å¿—
docker exec starpainting-digital-human-service-1 tail -f /tmp/gradio.log

# æŸ¥çœ‹BASE_PATHé…ç½®æ—¥å¿—
docker logs starpainting-digital-human-service-1 | grep "BASE_PATH"
docker exec starpainting-digital-human-service-1 tail -f /tmp/gradio.log | grep "BASE_PATH"
```

## ğŸ“Š æœåŠ¡çŠ¶æ€æ£€æŸ¥

### å®Œæ•´çš„æœåŠ¡çŠ¶æ€æ£€æŸ¥

```bash
# æ£€æŸ¥å®¹å™¨çŠ¶æ€
docker ps | grep starpainting-digital-human-service

# æ£€æŸ¥FastAPIæœåŠ¡
curl -s http://localhost:8308/health && echo " - FastAPIæ­£å¸¸"

# æ£€æŸ¥GradioæœåŠ¡
curl -s -o /dev/null -w "%{http_code}" http://localhost:7860 && echo " - Gradioæ­£å¸¸"

# æ£€æŸ¥è¿›ç¨‹
docker exec starpainting-digital-human-service-1 ps aux | grep -E "uvicorn|app.py" | grep -v grep
```

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. åˆå§‹åŒ–æ—¶é—´
- **FastAPIæœåŠ¡**: éœ€è¦çº¦30ç§’åˆå§‹åŒ–ï¼ˆæ¨¡å‹åŠ è½½ï¼‰
- **GradioæœåŠ¡**: éœ€è¦çº¦15ç§’åˆå§‹åŒ–ï¼ˆæœåŠ¡å¯åŠ¨ï¼‰

### 2. BASE_PATHé…ç½®
- æœåŠ¡å¯åŠ¨æ—¶ä¼šè‡ªåŠ¨æ£€æŸ¥ `BASE_PATH` ç›®å½•
- å¦‚æœä¸å­˜åœ¨ï¼Œä¼šè‡ªåŠ¨åˆ›å»º
- æ—¥å¿—ä¸­ä¼šè®°å½• `BASE_PATH` çš„çŠ¶æ€

### 3. ç«¯å£å†²çª
- FastAPIæœåŠ¡ä½¿ç”¨ç«¯å£ **8308**
- GradioæœåŠ¡ä½¿ç”¨ç«¯å£ **7860**
- ç¡®ä¿ç«¯å£æœªè¢«å…¶ä»–æœåŠ¡å ç”¨

### 4. ç¯å¢ƒå˜é‡
- å¿…é¡»è®¾ç½® `PYTHONPATH` å’Œ `LD_LIBRARY_PATH`
- å¿…é¡»æ¿€æ´»condaç¯å¢ƒ `human`

## ğŸ” æ•…éšœæ’æŸ¥

### é—®é¢˜1: å®¹å™¨æ— æ³•å¯åŠ¨

```bash
# æ£€æŸ¥å®¹å™¨çŠ¶æ€
docker ps -a | grep starpainting-digital-human-service

# æŸ¥çœ‹å®¹å™¨æ—¥å¿—
docker logs starpainting-digital-human-service-1

# æ£€æŸ¥DockeræœåŠ¡
systemctl status docker
```

### é—®é¢˜2: FastAPIæœåŠ¡æ— æ³•è®¿é—®

```bash
# æ£€æŸ¥æœåŠ¡è¿›ç¨‹
docker exec starpainting-digital-human-service-1 ps aux | grep uvicorn

# æ£€æŸ¥ç«¯å£
docker exec starpainting-digital-human-service-1 netstat -tlnp | grep 8308

# æŸ¥çœ‹æœåŠ¡æ—¥å¿—
docker logs starpainting-digital-human-service-1 | tail -50
```

### é—®é¢˜3: GradioæœåŠ¡æ— æ³•å¯åŠ¨

```bash
# æ£€æŸ¥è¿›ç¨‹
docker exec starpainting-digital-human-service-1 ps aux | grep "app.py"

# æŸ¥çœ‹Gradioæ—¥å¿—
docker exec starpainting-digital-human-service-1 tail -50 /tmp/gradio.log

# æ£€æŸ¥BASE_PATHé…ç½®
docker exec starpainting-digital-human-service-1 tail -50 /tmp/gradio.log | grep "BASE_PATH"
```

### é—®é¢˜4: BASE_PATHç›®å½•é—®é¢˜

```bash
# æ£€æŸ¥ç›®å½•æ˜¯å¦å­˜åœ¨
docker exec starpainting-digital-human-service-1 ls -ld /data2/home_back/gujiaxin/work/batchshort1/assrt/human

# æ£€æŸ¥ç›®å½•æƒé™
docker exec starpainting-digital-human-service-1 stat /data2/home_back/gujiaxin/work/batchshort1/assrt/human

# æ‰‹åŠ¨åˆ›å»ºç›®å½•
docker exec starpainting-digital-human-service-1 mkdir -p /data2/home_back/gujiaxin/work/batchshort1/assrt/human
```

## ğŸ“ æœåŠ¡è®¿é—®åœ°å€

- **FastAPIæœåŠ¡**: http://localhost:8308
  - å¥åº·æ£€æŸ¥: http://localhost:8308/health
  - APIæ–‡æ¡£: http://localhost:8308/docs

- **GradioæœåŠ¡**: http://localhost:7860
  - Webç•Œé¢: http://localhost:7860

## ğŸ”„ å®Œæ•´é‡å¯å‘½ä»¤ï¼ˆä¸€é”®æ‰§è¡Œï¼‰

```bash
# å®Œæ•´çš„é‡å¯å‘½ä»¤
docker restart starpainting-digital-human-service-1 && \
sleep 40 && \
docker exec starpainting-digital-human-service-1 pkill -f "python app.py" && \
sleep 2 && \
docker exec -d starpainting-digital-human-service-1 bash -c "source /opt/conda/etc/profile.d/conda.sh && conda activate human && cd /app/HeyGem-Linux-Python-Hack && export PYTHONPATH=/app/HeyGem-Linux-Python-Hack && export LD_LIBRARY_PATH=/opt/conda/envs/human/lib:\$LD_LIBRARY_PATH && nohup python app.py > /tmp/gradio.log 2>&1 &" && \
sleep 15 && \
echo "æœåŠ¡é‡å¯å®Œæˆï¼" && \
curl -s http://localhost:8308/health && echo " - FastAPIæ­£å¸¸" && \
curl -s -o /dev/null -w "%{http_code}" http://localhost:7860 && echo " - Gradioæ­£å¸¸"
```

## ğŸ“… æ›´æ–°æ—¥æœŸ

2025-01-27

## ğŸ”— ç›¸å…³æ–‡ä»¶

- `restart_service.sh` - è‡ªåŠ¨é‡å¯è„šæœ¬
- `start.sh` - FastAPIæœåŠ¡å¯åŠ¨è„šæœ¬
- `app.py` - Gradioåº”ç”¨ï¼ˆå·²é…ç½®BASE_PATHï¼‰
- `fastapi_app.py` - FastAPIåº”ç”¨ï¼ˆå·²é…ç½®BASE_PATHï¼‰


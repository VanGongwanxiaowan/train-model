# 队列阻塞问题深度分析 - 环境变量问题

## 问题诊断

### 当前状态

从日志分析发现：

1. **环境变量未设置**: 在运行时环境中，`ORT_PARALLEL`、`TORCH_DATALOADER_NUM_WORKERS`、`OMP_NUM_THREADS` 都显示为"未设置"
2. **多个 multiprocessing.spawn 进程**: 有很多 `multiprocessing.spawn` 进程在运行
3. **任务执行失败**: 任务在等待某些操作时超时
4. **num_threads: 0**: 配置是正确的，但可能没有生效

### 根本原因

**环境变量在 `app.py` 中设置，但子进程（multiprocessing.spawn）没有继承这些环境变量**

## 问题分析

### 1. 环境变量传递问题

在 `app.py` 中设置了环境变量：
```python
os.environ["ORT_PARALLEL"] = "0"
os.environ["TORCH_DATALOADER_NUM_WORKERS"] = "0"
os.environ["OMP_NUM_THREADS"] = "1"
```

但是，当使用 `multiprocessing.spawn` 启动子进程时，这些环境变量可能没有正确传递到子进程。

### 2. 多进程环境问题

从进程列表可以看到：
- 多个 `multiprocessing.spawn` 进程在运行
- 多个僵尸进程 (`<defunct>`)
- 说明多进程环境活跃，可能存在资源竞争

### 3. 任务执行流程问题

从日志看：
- 15:21:41 - 任务开始
- 15:21:46 - get_aud_feat1 完成
- 15:21:56 - 任务执行失败（10秒后）
- 15:22:01 - init_wh 完成（19.58秒后）

任务在等待 `init_wh` 完成时超时了，但 `init_wh` 实际上在任务失败后才完成。

## 解决方案

### 1. 确保环境变量在子进程启动前设置

环境变量需要在所有导入之前设置，并且需要确保子进程能够继承这些环境变量。

### 2. 使用 multiprocessing.get_context() 传递环境变量

在创建子进程时，需要确保环境变量被正确传递。

### 3. 检查 service 模块中的多进程设置

需要检查 `service/trans_dh_service.py` 中是否有多进程相关的代码，确保环境变量被正确传递。

## 修复建议

### 1. 在 app.py 中确保环境变量设置

确保环境变量在所有导入之前设置，并且在子进程启动前设置。

### 2. 在 service 模块中设置环境变量

在 `service/trans_dh_service.py` 中也需要设置环境变量，确保子进程能够继承。

### 3. 检查 multiprocessing 启动方式

确保使用 `multiprocessing.set_start_method("spawn", force=True)` 并在子进程启动前设置环境变量。

## 下一步

1. 检查 `service/trans_dh_service.py` 中的多进程代码
2. 确保环境变量在子进程启动前设置
3. 验证环境变量是否正确传递到子进程


# 任务失败问题修复说明

## 问题根本原因

### 问题现象

从日志分析可以看到：

```
[15:26:49] 预处理完成
[15:26:54] get_aud_feat1 完成（5.2秒）
[15:27:04] 任务执行失败（15.41秒后）
[15:27:06] init_wh 完成（16.77秒后）
```

### 根本原因

1. **任务执行是异步的**
   - `self.task.work()` 是异步执行的，启动子进程处理任务
   - 主线程调用后立即返回，不等待子进程完成

2. **任务状态检查过早**
   - 主线程在任务执行后立即检查状态
   - 但子进程需要时间完成 init_wh（16.77秒）
   - 如果检查时任务状态还未更新，可能会误判为失败

3. **init_wh 需要时间**
   - init_wh 通常需要 15-20 秒完成
   - 任务在 init_wh 完成之前就检查状态，导致误判

## 修复方案

### 修复内容

1. **等待 init_wh 完成**
   - 在检查任务状态前，先等待 25 秒
   - 确保 init_wh 有足够时间完成

2. **使用轮询方式检查任务状态**
   - 使用轮询方式检查任务状态
   - 每 2 秒检查一次，最大等待 5 分钟
   - 避免过早检查导致误判

3. **改进错误判断逻辑**
   - 如果任务状态为错误，再等待 5 秒确认
   - 如果仍然是错误，才判定为失败
   - 如果结果路径存在，可能是部分成功

### 修复代码

```python
# 关键修复：等待任务初始化完成（init_wh 通常需要 15-20 秒）
logger.info(f"[{code}] 等待任务初始化完成（init_wh，通常需要 15-20 秒）...")

# 首先等待一段时间，让 init_wh 有足够时间完成
init_wh_wait_time = 25  # 等待 25 秒，确保 init_wh 完成
logger.info(f"[{code}] 等待 {init_wh_wait_time} 秒以确保 init_wh 完成...")
time.sleep(init_wh_wait_time)

# 然后使用轮询方式检查任务状态，直到任务完成或超时
max_wait_time = 300  # 最大等待 5 分钟（任务总超时时间）
wait_interval = 2    # 每 2 秒检查一次
# ... 轮询检查逻辑 ...
```

## 预期效果

### 修复后

1. **避免过早检查**
   - 等待 init_wh 完成后再检查任务状态
   - 避免误判任务为失败

2. **更准确的错误判断**
   - 如果任务状态为错误，再等待确认
   - 如果结果路径存在，可能是部分成功

3. **更好的错误处理**
   - 增加详细的日志记录
   - 帮助诊断问题

## 验证方法

### 1. 测试功能

通过 Web 界面测试数字人生成功能，观察是否还有任务失败的问题。

### 2. 监控日志

观察日志中是否有以下信息：
- "等待任务初始化完成（init_wh）..."
- "开始轮询检查任务状态..."
- "任务成功完成" 或 "任务确认失败"

### 3. 检查任务执行时间

观察任务执行时间是否正常：
- init_wh 通常需要 15-20 秒
- 任务总耗时应该在合理范围内

## 注意事项

### 1. 等待时间

- init_wh 等待时间：25 秒（确保 init_wh 完成）
- 任务总超时时间：5 分钟（300 秒）
- 检查间隔：2 秒

### 2. 性能影响

- 增加等待时间可能会增加任务总耗时
- 但可以避免误判任务为失败
- 提高任务成功率

### 3. 错误处理

- 如果任务状态为错误，会再等待 5 秒确认
- 如果仍然是错误，才判定为失败
- 如果结果路径存在，可能是部分成功

## 更新日期

2025-11-09


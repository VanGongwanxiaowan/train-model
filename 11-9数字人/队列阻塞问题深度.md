# 队列阻塞问题深度分析 (2025-11-09)

## 问题现象

从日志 `dh.log (326-338)` 可以看到：

```
[2025-11-09 15:02:09,990] 任务视频驱动队列启动 batch_size:1, len:150
[2025-11-09 15:02:10,025] drivered_video >>>>>>>>>>>>>>>>>>>> 开始循环
[2025-11-09 15:02:10,104] drivered_video >>>>>>>>>>>>>>>>>>>> 发送数据大小:[1], current_idx:1
[2025-11-09 15:02:10,109] drivered_video >>>>>>>>>>>>>>>>>>>> 发送数据大小:[1], current_idx:2
...
[2025-11-09 15:02:10,146] drivered_video >>>>>>>>>>>>>>>>>>>> 发送数据大小:[1], current_idx:10
[2025-11-09 15:03:10,149] [ERROR] 任务视频驱动队列满，严重阻塞，下游队列异常
```

## 时间线分析

1. **15:02:09** - 队列启动，总长度 150
2. **15:02:10** - 快速发送 10 个数据（每个间隔几毫秒）
3. **15:03:10** - **1分钟后**，队列阻塞错误

## 问题分析

### 1. 队列阻塞的根本原因

**不是 ONNX Runtime 版本问题**，而是：

1. **`num_threads: 4` 导致 DataLoader 多进程死锁**
   - 当前配置：`num_threads: 4`
   - 问题：在多进程 CUDA 环境下，DataLoader 使用多个 worker 会导致死锁
   - 解决方案：改为 `num_threads: 0` ✅（已修复）

2. **环境变量未正确传递到子进程**
   - `app.py` 中设置了环境变量，但在实际运行的 Python 进程中显示为"未设置"
   - 这可能是因为子进程在设置环境变量之前启动，或者环境变量没有正确传递

3. **下游处理速度慢于上游发送速度**
   - 上游快速发送数据（10 个数据在几毫秒内）
   - 下游处理缓慢（1 分钟才处理 10 个数据或更少）
   - 队列被填满，导致阻塞

### 2. ONNX Runtime 版本影响

- **当前版本**: onnxruntime-gpu 1.18.0 ✅（已降级）
- **问题**: 虽然降级到 1.18.0，但队列阻塞仍然存在
- **结论**: ONNX Runtime 版本不是根本原因，而是 `num_threads` 配置问题

### 3. 多进程环境问题

从进程列表可以看到：
- 多个 `multiprocessing.spawn` 进程在运行
- 多个僵尸进程 (`<defunct>`)
- 说明多进程环境活跃，可能存在资源竞争

## 根本原因

**`num_threads: 4` 是导致队列阻塞的根本原因**

1. DataLoader 使用 4 个 worker 进程
2. 在多进程 CUDA 环境下，这些 worker 进程会竞争 GPU 资源
3. 导致死锁，下游处理停滞
4. 上游继续发送数据，队列被填满
5. 最终触发队列阻塞错误

## 解决方案

### 1. 修复 `num_threads` 配置 ✅

```bash
# 修改 opt.txt
num_threads: 4 -> num_threads: 0
```

**状态**: ✅ 已完成

### 2. 确保环境变量正确设置

虽然 `app.py` 中设置了环境变量，但需要确保：
- 环境变量在子进程启动前设置
- 环境变量正确传递到子进程

**当前设置**:
- `ORT_PARALLEL=0` ✅
- `TORCH_DATALOADER_NUM_WORKERS=0` ✅
- `OMP_NUM_THREADS=1` ✅

### 3. 重启服务

修复后需要重启服务以应用新配置。

## 验证方法

1. **检查 `num_threads` 配置**
   ```bash
   grep num_threads /app/HeyGem-Linux-Python-Hack/landmark2face_wy/checkpoints/test/opt.txt
   # 预期输出: num_threads: 0
   ```

2. **测试功能**
   - 通过 Web 界面测试数字人生成功能
   - 观察是否还有队列阻塞错误

3. **监控日志**
   - 观察日志中是否还有队列阻塞错误
   - 检查处理速度是否正常

## 更新日期

2025-11-09


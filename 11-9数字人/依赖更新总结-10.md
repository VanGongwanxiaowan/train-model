# 依赖更新总结

## 更新内容

已根据您提供的可运行的 `pyproject.toml` 配置文件，更新了项目的依赖配置。

## 创建/更新的文件

### 1. `requirements_0.txt` ✅
- 已更新为与 `pyproject.toml` 完全匹配的依赖版本
- 移除了不在 `pyproject.toml` 中的包（如 pandas）
- 保留了必要的注释说明
- 添加了 PyTorch 特殊安装说明

### 2. `pyproject.toml` ✅
- 创建了新的 `pyproject.toml` 文件
- 包含所有依赖和版本信息
- 配置了 PyTorch 专用镜像源（南大镜像）
- 配置了默认 Python 包镜像源（阿里云镜像）

### 3. `install_dependencies.sh` ✅
- 创建了自动化安装脚本
- 支持自动卸载旧版本 PyTorch
- 支持从正确的镜像源安装 PyTorch
- 包含安装验证步骤

### 4. `依赖安装说明.md` ✅
- 详细的安装指南
- 包含多种安装方式
- 常见问题解答
- 镜像源列表

## 关键依赖版本

| 包名 | 版本 | 说明 |
|------|------|------|
| torch | 2.1.2+cu118 | PyTorch 主框架 |
| torchvision | 0.16.2 | 计算机视觉工具包 |
| torchaudio | 2.1.2 | 音频处理工具包 |
| numpy | 1.22.4 | 数值计算库 |
| opencv-python | 4.7.0.72 | OpenCV |
| librosa | 0.8.1 | 音频分析库 |
| onnxruntime-gpu | 1.18.0 | ONNX 运行时 |
| transformers | 4.6.1 | Hugging Face transformers |

## 安装步骤

### 快速安装（推荐）

```bash
# 在容器内执行
docker exec -it starpainting-digital-human-service-1 bash
cd /app/HeyGem-Linux-Python-Hack
bash install_dependencies.sh
```

### 手动安装

```bash
# 1. 激活环境
source /opt/conda/etc/profile.d/conda.sh
conda activate human
cd /app/HeyGem-Linux-Python-Hack

# 2. 卸载旧版本 PyTorch
pip uninstall -y torch torchvision torchaudio triton

# 3. 安装 PyTorch（使用南大镜像）
pip install torch==2.1.2+cu118 torchvision==0.16.2 torchaudio==2.1.2 \
    -i https://mirror.nju.edu.cn/pytorch/whl/cu118 \
    --trusted-host mirror.nju.edu.cn

# 4. 安装其他依赖
pip install -r requirements_0.txt \
    -i https://mirrors.aliyun.com/pypi/web/simple \
    --trusted-host mirrors.aliyun.com
```

## 注意事项

### 1. PyTorch 安装
- **必须使用专用镜像源**：`https://mirror.nju.edu.cn/pytorch/whl/cu118`
- 或使用 PyTorch 官方源：`https://download.pytorch.org/whl/cu118`
- 不能使用普通的 PyPI 镜像源安装 PyTorch CUDA 版本

### 2. Gradio 依赖
- `app.py` 使用了 Gradio，但原始的 `pyproject.toml` 中没有包含
- 需要单独安装：`pip install gradio>=4.0.0`
- 已在 `requirements_0.txt` 中添加注释说明

### 3. 版本匹配
- 所有依赖版本已与可运行的 `pyproject.toml` 完全匹配
- 确保使用指定的版本，避免兼容性问题

### 4. 镜像源
- **PyTorch**: 使用南大镜像或 PyTorch 官方源
- **其他包**: 使用阿里云镜像或清华镜像

## 验证安装

安装完成后，运行以下命令验证：

```bash
python -c "
import torch
import cv2
import numpy as np
import librosa

print('PyTorch:', torch.__version__)
print('CUDA 可用:', torch.cuda.is_available())
print('OpenCV:', cv2.__version__)
print('NumPy:', np.__version__)
print('Librosa:', librosa.__version__)
"
```

## 文件对比

### 与原始配置的差异

| 项目 | 原始版本 | 新版本 | 状态 |
|------|---------|--------|------|
| torch | 1.11.0+cu113 | 2.1.2+cu118 | ✅ 已更新 |
| numpy | 1.24.4 | 1.22.4 | ✅ 已降级 |
| opencv-python | 4.11.0.86 | 4.7.0.72 | ✅ 已降级 |
| librosa | 0.11.0 | 0.8.1 | ✅ 已降级 |
| onnxruntime-gpu | 1.16.0 | 1.18.0 | ✅ 已更新 |
| transformers | 2.3.0 | 4.6.1 | ✅ 已更新 |

## 下一步

1. **安装依赖**: 运行 `install_dependencies.sh` 或手动安装
2. **验证安装**: 检查所有包是否正确安装
3. **重启服务**: 重启 Gradio 服务以应用更改
4. **测试功能**: 测试视频生成功能是否正常

## 相关文件

- `requirements_0.txt` - 依赖列表
- `pyproject.toml` - 项目配置文件
- `install_dependencies.sh` - 安装脚本
- `依赖安装说明.md` - 详细安装指南

## 更新日期

2025-11-09


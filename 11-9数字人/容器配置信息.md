# 容器 starpainting-digital-human-service-1 配置信息

## 基本信息

- **容器名称**: `starpainting-digital-human-service-1`
- **容器ID**: 
- **镜像**: `heygem:v2.2`
- **状态**: 运行中 (Up 47 minutes)
- **启动命令**: `/opt/nvidia/nvidia_entrypoint.sh bash start.sh`

## 端口映射

| 容器端口 | 主机端口 | 协议 | 说明 |
|---------|---------|------|------|
| 7860 | 7860 | TCP | Gradio Web 服务端口 |
| 8308 | 8308 | TCP | FastAPI 服务端口（推测） |

**访问地址**:
- Gradio: http://localhost:7860
- API: http://localhost:8308

## 卷挂载 (Volume Mounts)

| 主机路径 | 容器路径 | 模式 | 说明 |
|---------|---------|------|------|
| `/data2/home_back/gujiaxin/work/starpainting/backend/services/digital-human-service` | `/app` | rw (读写) | 项目代码挂载 |

## GPU 配置

- **GPU 数量**: 8x NVIDIA A100-SXM4-80GB
- **GPU 显存**: 每块 81920 MiB (80GB)
- **驱动版本**: 535.104.12
- **CUDA 版本**: 12.4.0
- **GPU 访问**: 通过 `--gpus all` 参数启用

## 共享内存 (Shared Memory)

- **当前大小**: 64 MB (`ShmSize: 67108864`)
- **使用情况**: 308 KB / 64 MB (1%)
- **问题**: **共享内存过小**，可能导致多进程数据加载问题
- **建议**: 增加到至少 2GB (`--shm-size=2g`)

## Conda 环境配置

- **Conda 路径**: `/opt/conda`
- **环境列表**:
  - `base`: `/opt/conda`
  - `human`: `/opt/conda/envs/human` (当前使用)

### human 环境详情

- **Python 版本**: 3.8.20
- **Python 路径**: `/opt/conda/envs/human/bin/python`

## 环境变量 (Environment Variables)

### CUDA 相关
- `CUDA_VERSION=12.4.0`
- `NV_CUDA_CUDART_VERSION=12.4.99-1`
- `NV_CUDA_COMPAT_PACKAGE=cuda-compat-12-4`

### PATH 相关
- `PATH=/opt/conda/bin:/usr/local/nvidia/bin:/usr/local/cuda/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin`

### NVIDIA 驱动要求
- 支持多种 GPU 品牌 (Tesla, GeForce, Quadro, Titan 等)
- 驱动版本要求: >=470, >=525, >=535

## 当前安装的 Python 包（部分）

### 已安装的包版本
- **PyTorch**: 1.11.0+cu113 ❌ (需要更新到 2.1.2+cu118)
- **OpenCV**: 4.11.0.86 ❌ (需要降级到 4.7.0.72)
- **OpenCV-headless**: 4.12.0.88 (可能冲突)
- **NumPy**: 1.24.4 ❌ (需要降级到 1.22.4)
- **Librosa**: 0.11.0 ❌ (需要降级到 0.8.1)

### 版本不匹配问题
- 容器 CUDA 版本: 12.4.0
- PyTorch 编译版本: CUDA 11.3
- **严重不匹配**: 可能导致性能问题或运行时错误

## 项目路径结构

```
容器内路径: /app/HeyGem-Linux-Python-Hack/
├── app.py                    # Gradio 应用主文件
├── run.py                    # 命令行运行脚本
├── requirements_0.txt        # Python 依赖文件
├── config/
│   └── config.ini           # 配置文件
├── log/
│   └── dh.log              # 应用日志
├── service/                 # 服务模块
├── model_lib/               # 模型库
└── ...
```

## 重启策略

- **重启策略**: `no` (不自动重启)
- **最大重试次数**: 0

## 网络配置

- **网络模式**: `default` (bridge)
- **容器IP**: 172.17.0.3
- **网关**: 172.17.0.1
- **网络ID**: 284e85c918bdb0b98e47c6bcab424cd627ead8807b0752a1b15433bdaa7fdd66

## 资源限制

- **CPU**: 无限制 (0 = 无限制)
- **内存**: 无限制 (0 = 无限制)
- **共享内存**: 64 MB (需要增加)

## 应用配置文件 (config.ini)

```ini
[log]
log_dir = ./log
log_file = dh.log

[http_server]
server_ip = 0.0.0.0
server_port = 8383

[temp]
temp_dir = ./
clean_switch = 1

[result]
result_dir = ./result
clean_switch = 0

[digital]
batch_size = 1

[register]
url = http://172.16.160.51:12120
report_interval = 10
enable=0
```

## 已知问题

### 1. 共享内存过小 ⚠️
- **当前**: 64 MB
- **问题**: 可能导致多进程数据加载时队列阻塞
- **解决方案**: 增加到 2GB (`--shm-size=2g`)

### 2. PyTorch 版本不匹配 ❌
- **当前**: 1.11.0+cu113
- **目标**: 2.1.2+cu118
- **问题**: 版本过旧，可能导致队列阻塞问题

### 3. CUDA 版本不匹配 ⚠️
- **容器 CUDA**: 12.4.0
- **PyTorch 编译**: CUDA 11.3
- **问题**: 虽然可以运行，但可能影响性能和稳定性

### 4. Python 包版本不匹配 ❌
- **OpenCV**: 4.11.0.86 (需要 4.7.0.72)
- **NumPy**: 1.24.4 (需要 1.22.4)
- **Librosa**: 0.11.0 (需要 0.8.1)
- **问题**: 可能与稳定配置不兼容

### 5. OpenCV 重复安装 ⚠️
- 同时安装了 `opencv-python` 和 `opencv-python-headless`
- 可能导致冲突

## 建议的容器启动命令

如果要重新创建容器，建议使用以下命令：

```bash
docker run -d \
  --name starpainting-digital-human-service-1 \
  --gpus all \
  --shm-size=2g \
  -p 7860:7860 \
  -p 8308:8308 \
  -v /data2/home_back/gujiaxin/work/starpainting/backend/services/digital-human-service:/app \
  heygem:v2.2
```

**关键改进**:
- `--shm-size=2g`: 增加共享内存到 2GB
- 保持现有的端口映射和卷挂载

## 检查命令

### 检查容器状态
```bash
docker ps | grep starpainting-digital-human-service
```

### 检查 GPU 使用
```bash
docker exec starpainting-digital-human-service-1 nvidia-smi
```

### 检查 Python 环境
```bash
docker exec starpainting-digital-human-service-1 bash -c "source /opt/conda/etc/profile.d/conda.sh && conda activate human && python --version"
```

### 检查 PyTorch 版本
```bash
docker exec starpainting-digital-human-service-1 bash -c "source /opt/conda/etc/profile.d/conda.sh && conda activate human && python -c 'import torch; print(torch.__version__)'"
```

### 检查共享内存
```bash
docker exec starpainting-digital-human-service-1 df -h /dev/shm
```

## 更新日期

2025-11-09

